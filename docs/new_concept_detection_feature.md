# 新概念识别功能说明

## 功能概述

为了解决"新概念板块"可能被遗漏的问题，系统已增加**新概念自动识别机制**。

## 问题背景

### 原有问题

在之前的实现中，系统要求**所有概念必须有至少5个交易日的历史数据**才能参与排名：

```python
# 旧逻辑（有问题）
if len(last_5_days) < 5:
    logger.debug(f"{concept_name} 交易日数量不足5个，跳过")
    continue  # ❌ 直接忽略新概念
```

**导致的后果：**
- 同花顺新增的概念板块（如"AI+机器人"）在前5个交易日内会被**直接跳过**
- 即使新概念涨幅很高，也**无法进入热门榜单**
- 要等到约一周后才能被系统采集
- **可能错过新概念的最佳热点期**（新概念通常在初期最活跃）

## 解决方案

### 新逻辑

系统现在采用**灵活的交易日数量策略**：

```python
# 新逻辑（已修复）
# 取最后5个交易日的数据（如果不足5个，则取全部）
last_5_days = index_df.tail(5) if len(index_df) >= 5 else index_df

# 如果交易日数量不足2个，跳过该概念（至少需要2天才能计算涨幅）
if len(last_5_days) < 2:
    logger.debug(f"{concept_name} 交易日数量不足2个，跳过")
    continue

# 标记新概念（历史数据不足5个交易日）
is_new_concept = len(last_5_days) < 5
actual_trading_days = len(last_5_days)
```

### 核心改进

1. **最低要求降低**：从5个交易日降低到**2个交易日**
   - 只要有2天数据就能计算涨幅
   - 新概念从第2个交易日就能参与排名

2. **自动识别新概念**：
   - 历史数据不足5个交易日的概念会被标记为"新概念"
   - 在日志中显示 🆕 标记

3. **特殊日志输出**：
   ```python
   if is_new_concept:
       logger.info(
           f"🆕 发现新概念: {concept_name} "
           f"(仅{actual_trading_days}个交易日数据，{actual_trading_days}日涨幅: {total_change_pct:.2f}%)"
       )
   ```

## 工作流程

### 对于成熟概念（≥5个交易日）

1. 获取最近15天数据
2. 取最后5个交易日
3. 计算5日累计涨幅：`(最新收盘价 - 5日前收盘价) / 5日前收盘价 × 100%`
4. 参与排名

### 对于新概念（2-4个交易日）

1. 获取最近15天数据
2. 取**所有可用的交易日**（例如3天）
3. 计算**实际天数的累计涨幅**：`(最新收盘价 - 第一日收盘价) / 第一日收盘价 × 100%`
4. **同样参与排名**（与成熟概念竞争）
5. 在日志中标记 🆕

## 示例场景

### 场景1：新概念刚上线

**假设：** 同花顺今天（12月8日）新增概念"AI+机器人"

| 日期 | 状态 | 系统行为 |
|------|------|---------|
| 12月6日 | 概念创建，仅1天数据 | ❌ 跳过（不足2天） |
| 12月7日 | 第2个交易日 | ✅ **开始采集**，计算2日涨幅，标记 🆕 |
| 12月8日 | 第3个交易日 | ✅ 计算3日涨幅，标记 🆕 |
| 12月9日 | 第4个交易日 | ✅ 计算4日涨幅，标记 🆕 |
| 12月10日 | 第5个交易日 | ✅ 计算5日涨幅，标记 🆕 |
| 12月13日 | 第6个交易日 | ✅ 计算5日涨幅（正常概念，不再标记 🆕） |

### 场景2：新概念涨幅很高

**假设：** "AI+机器人"概念在第2、3天分别上涨10%、15%

```
12月7日（第2天）：
- 2日累计涨幅：25%
- 排名：第3名 🆕
- 日志：🆕 发现新概念: AI+机器人 (仅2个交易日数据，2日涨幅: 25.00%)
- 结果：成功进入前50，被保存到数据库
```

**对比旧逻辑：**
- ❌ 旧逻辑：直接跳过，错过热点
- ✅ 新逻辑：第2天就能识别，及时捕捉

## 日志示例

运行采集脚本时，如果发现新概念，会看到：

```
10:23:15 | INFO | 开始处理 374 个概念板块...
10:23:18 | INFO | 🆕 发现新概念: AI+机器人 (仅3个交易日数据，3日涨幅: 28.50%)
10:23:22 | INFO | 🆕 发现新概念: 量子通信2.0 (仅2个交易日数据，2日涨幅: 15.20%)
10:24:01 | INFO | 成功采集 50 个热门概念板块（交易日: 2025-12-08，按累计涨幅排序）
10:24:01 | INFO |   [1] 人工智能: 涨幅 10.23%
10:24:01 | INFO |   [2] AI+机器人: 涨幅 28.50%  👈 新概念排第2
10:24:01 | INFO |   [3] 芯片: 涨幅 8.76%
```

## 技术细节

### 代码位置

`backend/app/services/collectors/hot_concepts_collector.py`

**关键修改点：**

1. **lines 142-149**：新概念识别逻辑
```python
if len(last_5_days) < 2:
    logger.debug(f"{concept_name} 交易日数量不足2个，跳过")
    continue

is_new_concept = len(last_5_days) < 5
actual_trading_days = len(last_5_days)
```

2. **lines 157-170**：涨幅计算和新概念标记
```python
total_change_pct = ((curr_close - first_close) / first_close) * 100

if is_new_concept:
    logger.info(
        f"🆕 发现新概念: {concept_name} "
        f"(仅{actual_trading_days}个交易日数据，{actual_trading_days}日涨幅: {total_change_pct:.2f}%)"
    )
```

### 测试脚本

创建了专门的测试脚本来验证新概念识别功能：

```bash
cd backend
source venv/bin/activate
python3 ../scripts/test-new-concept-detection.py
```

## 优势

1. **不会遗漏新热点**
   - 新概念从第2个交易日就能被识别
   - 及时捕捉市场新趋势

2. **自动化识别**
   - 系统自动检测新概念
   - 无需人工干预

3. **透明化展示**
   - 日志中明确标记 🆕
   - 便于监控和分析

4. **公平竞争**
   - 新概念和成熟概念在同一排行榜竞争
   - 涨幅高的新概念能快速进入前50

## 注意事项

1. **涨幅计算周期不同**
   - 成熟概念：固定5日涨幅
   - 新概念：实际可用天数涨幅（2-4天）
   - 这意味着新概念的涨幅可能基于更短的时间周期

2. **数据质量要求**
   - 至少需要2个交易日数据
   - 不足2天的概念仍会被跳过

3. **排名竞争**
   - 新概念使用2-4天的涨幅与5天涨幅的概念竞争
   - 如果新概念涨幅不够高，可能进不了前50
   - 这是合理的，因为只有真正热门的新概念才值得关注

## 相关文件

- 代码：`backend/app/services/collectors/hot_concepts_collector.py`
- 测试脚本：`scripts/test-new-concept-detection.py`
- 完整采集脚本：`scripts/collect-full-hot-concepts.py`

## 总结

**修改前：**
- ❌ 新概念要等5个交易日才能被采集
- ❌ 可能错过新概念的最佳热点期
- ❌ 无法识别刚出现的市场趋势

**修改后：**
- ✅ 新概念从第2个交易日就能被识别
- ✅ 及时捕捉新热点，不会遗漏
- ✅ 日志中明确标记 🆕，便于监控
- ✅ 自动化、透明化、公平化
