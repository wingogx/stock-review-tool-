# 短线交易复盘需求分析与实现方案

基于截图中的专业短线交易者需求，整合技术实现方案。

---

## 📋 需求清单对照表

| 模块 | 原始需求 | 数据来源 | AKShare API | 优先级 |
|------|---------|---------|-------------|--------|
| **1. 大盘指数区** | | | | |
| 上证指数等 | 资讯成增、创业板指 | 东方财富 | `ak.stock_zh_index_daily()` | ⭐⭐⭐ |
| 每日涨跌幅 | 涨跌幅、振幅、成交额 | 东方财富 | 同上 | ⭐⭐⭐ |
| 小K线 | 最近5日或10日缩略图 | 历史数据 | `ak.stock_zh_index_daily()` | ⭐⭐ |
| **2. 市场成交 & 情绪区** | | | | |
| 全市场成交额 | 沪深两市总成交额 | 东方财富 | `ak.stock_zh_a_spot_em()` 汇总 | ⭐⭐⭐ |
| 涨停家数 | 涨停数量统计 | 东方财富 | `ak.stock_zt_pool_em()` | ⭐⭐⭐ |
| 跌停家数 | 跌停数量统计 | 东方财富 | `ak.stock_dt_pool_em()` | ⭐⭐⭐ |
| 涨跌比 | 上涨家数/下跌家数 | 东方财富 | `ak.stock_zh_a_spot_em()` 计算 | ⭐⭐⭐ |
| 连板数分布 | 2连板、3连板...统计 | 东方财富 | `ak.stock_zt_pool_em()` 解析 | ⭐⭐⭐ |
| 炸板率 | 封板成功/开板的比率 | 东方财富 | `ak.stock_zt_pool_zbgc_em()` | ⭐⭐ |
| **3. 涨跌停个股列表** | | | | |
| 涨停列表 | 代码、名称、涨幅、封板时间等 | 东方财富 | `ak.stock_zt_pool_em()` | ⭐⭐⭐ |
| 跌停列表 | 同上 | 东方财富 | `ak.stock_dt_pool_em()` | ⭐⭐⭐ |
| 简单筛选 | 过滤ST、新股等 | 本地处理 | Python 过滤 | ⭐⭐ |
| **4. 龙虎榜数据** | | | | |
| 上榜个股 | 代码、名称、上榜原因 | 东方财富 | `ak.stock_lhb_detail_em()` | ⭐⭐⭐ |
| 买入前5席位 | 营业部、买入金额 | 东方财富 | `ak.stock_lhb_stock_detail_em()` | ⭐⭐⭐ |
| 卖出前5席位 | 营业部、卖出金额 | 东方财富 | 同上 | ⭐⭐⭐ |
| 机构席位统计 | 机构买入/卖出统计 | 需解析 | 需要后期处理 | ⭐⭐ |
| 游资席位统计 | 频繁上榜的营业部 | 需解析 | 需要后期处理 | ⭐⭐ |
| **5. 热门概念/板块区** | | | | |
| 热门概念TOP5-10 | 概念名、涨幅、上涨/下跌数 | 东方财富 | `ak.stock_board_concept_name_em()` | ⭐⭐⭐ |
| 龙头股 | 概念内涨幅最高股票 | 东方财富 | `ak.stock_board_concept_cons_em()` | ⭐⭐⭐ |
| 前三权重股 | 概念内前三权重股票 | 需计算 | 需要后期处理 | ⭐ |
| 与跟踪股联动 | 自选股是否在热门概念中 | 本地关联 | SQL JOIN | ⭐⭐ |
| **6. 自选/重点跟踪股票区** | | | | |
| 自选股票池 | 用户自定义股票列表 | Supabase | 用户表 | ⭐⭐⭐ |
| 每日行情 | 当前价、涨跌幅、成交额等 | 东方财富 | `ak.stock_zh_a_hist()` | ⭐⭐⭐ |
| 是否上龙虎榜 | 标记是否上榜 | 关联查询 | SQL JOIN | ⭐⭐ |
| 是否在热门概念 | 标记所属热门概念 | 关联查询 | SQL JOIN | ⭐⭐ |
| 创新高等标记 | 是否创新高/新低 | 需计算 | 历史数据对比 | ⭐ |

---

## 🔧 核心功能模块设计

### **模块1: 大盘指数仪表盘**

**功能点:**
- 展示上证、深证、创业板三大指数
- 当日涨跌幅、振幅、成交额
- 最近5-10日K线缩略图

**数据表:**
```sql
-- 已有: market_index 表
-- 需要增加字段: amplitude (振幅)
ALTER TABLE market_index ADD COLUMN amplitude DECIMAL(10, 4);
```

**数据采集:**
```python
def get_market_index_enhanced():
    """增强版大盘指数数据"""
    indices = {
        "sh000001": "上证指数",
        "sz399001": "深证成指",
        "sz399006": "创业板指"
    }

    for code, name in indices.items():
        # 获取最近10天数据（用于绘制小K线）
        df = ak.stock_zh_index_daily(symbol=code)
        last_10 = df.tail(10)

        # 计算振幅
        latest = df.iloc[-1]
        amplitude = ((latest['high'] - latest['low']) / latest['close']) * 100

        # 保存数据...
```

---

### **模块2: 市场成交与情绪分析**

**核心指标:**
1. **全市场成交额** (沪深两市总和)
2. **涨停家数**
3. **跌停家数**
4. **涨跌比** (上涨家数 / 下跌家数)
5. **连板数分布** (2连板、3连板...10+连板)
6. **炸板率** (封板成功率)

**新增数据表:**
```sql
CREATE TABLE market_sentiment (
    id BIGSERIAL PRIMARY KEY,
    trade_date DATE NOT NULL UNIQUE,

    -- 成交数据
    total_amount DECIMAL(20, 2),  -- 全市场成交额
    sh_amount DECIMAL(20, 2),     -- 沪市成交额
    sz_amount DECIMAL(20, 2),     -- 深市成交额

    -- 涨跌统计
    up_count INT,                 -- 上涨家数
    down_count INT,               -- 下跌家数
    flat_count INT,               -- 平盘家数
    up_down_ratio DECIMAL(10, 4), -- 涨跌比

    -- 涨跌停统计
    limit_up_count INT,           -- 涨停数
    limit_down_count INT,         -- 跌停数

    -- 连板分布 (JSON 格式)
    continuous_limit_distribution JSONB,
    -- 例如: {"2连板": 15, "3连板": 8, "4连板": 3}

    -- 炸板率
    exploded_count INT,           -- 炸板数量
    explosion_rate DECIMAL(10, 4), -- 炸板率

    created_at TIMESTAMP DEFAULT NOW()
);
```

**数据采集:**
```python
def get_market_sentiment():
    """市场情绪数据采集"""

    # 1. 获取全市场实时行情
    all_stocks = ak.stock_zh_a_spot_em()

    # 2. 统计涨跌家数
    up_count = len(all_stocks[all_stocks['涨跌幅'] > 0])
    down_count = len(all_stocks[all_stocks['涨跌幅'] < 0])
    flat_count = len(all_stocks[all_stocks['涨跌幅'] == 0])

    # 3. 计算总成交额
    total_amount = all_stocks['成交额'].sum()

    # 4. 获取涨停池数据
    zt_pool = ak.stock_zt_pool_em(date=today)
    limit_up_count = len(zt_pool)

    # 5. 计算连板分布
    continuous_distribution = {}
    for i in range(2, 11):
        count = len(zt_pool[zt_pool['连板数'] == i])
        if count > 0:
            continuous_distribution[f"{i}连板"] = count

    # 6. 获取炸板数据
    exploded = ak.stock_zt_pool_zbgc_em(date=today)
    exploded_count = len(exploded)
    explosion_rate = (exploded_count / limit_up_count * 100) if limit_up_count > 0 else 0

    return {
        "trade_date": today,
        "total_amount": float(total_amount),
        "up_count": up_count,
        "down_count": down_count,
        "up_down_ratio": up_count / down_count if down_count > 0 else 0,
        "limit_up_count": limit_up_count,
        "continuous_limit_distribution": continuous_distribution,
        "exploded_count": exploded_count,
        "explosion_rate": explosion_rate
    }
```

---

### **模块3: 涨跌停个股详细列表**

**功能点:**
- 涨停股票列表（代码、名称、涨幅、封板时间、成交额、所属概念）
- 跌停股票列表
- 筛选功能：过滤ST、过滤新股

**新增数据表:**
```sql
CREATE TABLE limit_stocks_detail (
    id BIGSERIAL PRIMARY KEY,
    trade_date DATE NOT NULL,
    stock_code VARCHAR(10) NOT NULL,
    stock_name VARCHAR(50),

    -- 类型：涨停/跌停
    limit_type VARCHAR(10), -- 'limit_up' / 'limit_down'

    -- 涨停相关
    change_pct DECIMAL(10, 4),
    close_price DECIMAL(10, 2),
    first_limit_time TIME,      -- 首次封板时间
    last_limit_time TIME,       -- 最后封板时间
    limit_times INT,            -- 封板次数
    continuous_days INT,        -- 连板天数
    turnover_rate DECIMAL(10, 4),
    amount DECIMAL(20, 2),

    -- 标签
    is_st BOOLEAN DEFAULT FALSE,
    is_new_stock BOOLEAN DEFAULT FALSE,
    concepts TEXT[],            -- 所属概念

    -- 封板强度
    sealed_amount DECIMAL(20, 2), -- 封单金额
    opening_times INT,           -- 开板次数

    created_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(trade_date, stock_code, limit_type)
);

CREATE INDEX idx_limit_stocks_date ON limit_stocks_detail(trade_date);
CREATE INDEX idx_limit_stocks_type ON limit_stocks_detail(limit_type);
```

**数据采集:**
```python
def get_limit_stocks_detail():
    """涨跌停个股详细数据"""

    # 1. 涨停池数据
    zt_df = ak.stock_zt_pool_em(date=today)

    limit_up_stocks = []
    for _, row in zt_df.iterrows():
        stock_data = {
            "trade_date": today,
            "stock_code": row['代码'],
            "stock_name": row['名称'],
            "limit_type": "limit_up",
            "change_pct": float(row['涨跌幅']),
            "close_price": float(row['最新价']),
            "first_limit_time": row['首次封板时间'],
            "last_limit_time": row['最后封板时间'],
            "continuous_days": int(row.get('连板数', 1)),
            "turnover_rate": float(row.get('换手率', 0)),
            "amount": float(row.get('成交额', 0)),
            "is_st": 'ST' in row['名称'] or '*' in row['名称'],
            "is_new_stock": row.get('是否新股', False),
            "concepts": row.get('所属行业', '').split(','),
            "opening_times": int(row.get('开板次数', 0))
        }
        limit_up_stocks.append(stock_data)

    # 2. 跌停池数据
    dt_df = ak.stock_dt_pool_em(date=today)
    # 类似处理...

    return limit_up_stocks
```

---

### **模块4: 龙虎榜增强分析**

**新增功能:**
- 机构席位统计（机构买入/卖出总额）
- 游资席位统计（高频营业部排行）
- 营业部画像（某营业部的历史成功率）

**新增数据表:**
```sql
-- 机构席位统计表
CREATE TABLE institutional_seats (
    id BIGSERIAL PRIMARY KEY,
    trade_date DATE NOT NULL,
    stock_code VARCHAR(10) NOT NULL,
    stock_name VARCHAR(50),
    institutional_buy_count INT,   -- 机构买入席位数
    institutional_sell_count INT,  -- 机构卖出席位数
    institutional_buy_amount DECIMAL(20, 2),
    institutional_sell_amount DECIMAL(20, 2),
    institutional_net_amount DECIMAL(20, 2),
    created_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(trade_date, stock_code)
);

-- 游资席位排行表
CREATE TABLE hot_money_ranking (
    id BIGSERIAL PRIMARY KEY,
    trade_date DATE NOT NULL,
    seat_name TEXT,               -- 营业部名称
    appearance_count INT,         -- 上榜次数
    total_buy_amount DECIMAL(20, 2),
    total_sell_amount DECIMAL(20, 2),
    net_amount DECIMAL(20, 2),
    success_rate DECIMAL(10, 4),  -- 成功率（后续统计）
    created_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(trade_date, seat_name)
);
```

**数据采集:**
```python
def analyze_dragon_tiger_seats():
    """龙虎榜席位分析"""

    # 获取当日龙虎榜所有股票
    lhb_stocks = ak.stock_lhb_detail_em(start_date=today, end_date=today)

    institutional_data = []
    hot_money_stats = {}

    for _, stock in lhb_stocks.iterrows():
        code = stock['代码']

        # 获取买入席位
        buy_seats = ak.stock_lhb_stock_detail_em(
            symbol=code, date=today, flag="买入"
        )

        # 统计机构席位
        institutional_buy = buy_seats[
            buy_seats['交易营业部名称'].str.contains('机构专用|机构席位')
        ]

        inst_buy_count = len(institutional_buy)
        inst_buy_amount = institutional_buy['买入金额'].sum()

        # 统计游资（非机构席位）
        hot_money_seats = buy_seats[
            ~buy_seats['交易营业部名称'].str.contains('机构专用|机构席位')
        ]

        for _, seat in hot_money_seats.iterrows():
            seat_name = seat['交易营业部名称']
            if seat_name not in hot_money_stats:
                hot_money_stats[seat_name] = {
                    "appearance_count": 0,
                    "total_buy_amount": 0,
                    "total_sell_amount": 0
                }
            hot_money_stats[seat_name]["appearance_count"] += 1
            hot_money_stats[seat_name]["total_buy_amount"] += seat['买入金额']

        # ... 类似处理卖出席位

    return institutional_data, hot_money_stats
```

---

### **模块5: 热门概念深度分析**

**新增功能:**
- 概念内龙头股识别
- 概念内前三权重股
- 概念强度评分（涨幅*上涨家数）

**数据表增强:**
```sql
ALTER TABLE hot_concepts
ADD COLUMN leading_stocks TEXT[],      -- 龙头股列表（前3）
ADD COLUMN top_weighted_stocks TEXT[], -- 权重股列表
ADD COLUMN concept_strength DECIMAL(10, 4), -- 概念强度
ADD COLUMN avg_change_pct DECIMAL(10, 4);  -- 平均涨幅
```

**数据采集:**
```python
def get_hot_concepts_enhanced():
    """热门概念增强数据"""

    # 1. 获取所有概念板块
    concepts_df = ak.stock_board_concept_name_em()

    enhanced_data = []

    for _, concept in concepts_df.head(10).iterrows():
        concept_code = concept['板块代码']

        # 2. 获取概念成分股
        stocks_df = ak.stock_board_concept_cons_em(symbol=concept['板块名称'])

        # 3. 识别龙头股（涨幅最高的前3只）
        top_stocks = stocks_df.nlargest(3, '涨跌幅')
        leading_stocks = top_stocks['名称'].tolist()

        # 4. 计算概念强度 = 平均涨幅 * 上涨家数
        avg_change = stocks_df['涨跌幅'].mean()
        up_count = len(stocks_df[stocks_df['涨跌幅'] > 0])
        strength = avg_change * up_count

        enhanced_data.append({
            "trade_date": today,
            "concept_name": concept['板块名称'],
            "change_pct": concept['涨跌幅'],
            "leading_stocks": leading_stocks,
            "concept_strength": strength,
            "avg_change_pct": avg_change,
            "up_count": up_count
        })

    return enhanced_data
```

---

### **模块6: 自选股智能监控**

**核心功能:**
- 是否上龙虎榜（标记+提醒）
- 是否在热门概念（标记概念名）
- 是否创新高/新低
- 异动监控（大幅波动、放量等）

**数据表:**
```sql
-- 自选股每日监控表
CREATE TABLE watchlist_monitoring (
    id BIGSERIAL PRIMARY KEY,
    trade_date DATE NOT NULL,
    stock_code VARCHAR(10) NOT NULL,
    stock_name VARCHAR(50),

    -- 基础行情
    close_price DECIMAL(10, 2),
    change_pct DECIMAL(10, 4),
    turnover_rate DECIMAL(10, 4),
    amount DECIMAL(20, 2),

    -- 特殊标记
    is_on_dragon_tiger BOOLEAN DEFAULT FALSE,
    dragon_tiger_reason TEXT,

    is_in_hot_concept BOOLEAN DEFAULT FALSE,
    hot_concepts TEXT[],

    is_new_high BOOLEAN DEFAULT FALSE,   -- 创历史新高
    is_new_low BOOLEAN DEFAULT FALSE,    -- 创历史新低

    -- 异动标记
    is_abnormal BOOLEAN DEFAULT FALSE,
    abnormal_reason TEXT,

    created_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(trade_date, stock_code)
);
```

**监控逻辑:**
```python
def monitor_watchlist():
    """自选股监控"""

    # 1. 获取用户自选股列表
    watchlist = supabase.table("user_watchlist").select("*").execute()

    monitoring_data = []

    for stock in watchlist.data:
        code = stock['stock_code']

        # 2. 获取当日行情
        hist = ak.stock_zh_a_hist(symbol=code, period="daily", start_date=today, end_date=today)

        # 3. 检查是否上龙虎榜
        lhb = supabase.table("dragon_tiger_board")\
            .select("*")\
            .eq("trade_date", today)\
            .eq("stock_code", code)\
            .execute()

        is_on_lhb = len(lhb.data) > 0
        lhb_reason = lhb.data[0]['reason'] if is_on_lhb else None

        # 4. 检查是否在热门概念
        hot_concepts = []
        concepts = supabase.table("hot_concepts")\
            .select("*")\
            .eq("trade_date", today)\
            .execute()

        for concept in concepts.data:
            # 获取概念成分股
            stocks = ak.stock_board_concept_cons_em(symbol=concept['concept_name'])
            if code in stocks['代码'].values:
                hot_concepts.append(concept['concept_name'])

        # 5. 检查是否创新高
        hist_60 = ak.stock_zh_a_hist(symbol=code, period="daily", adjust="qfq")
        current_price = hist.iloc[-1]['收盘']
        is_new_high = current_price >= hist_60['收盘'].max()

        monitoring_data.append({
            "trade_date": today,
            "stock_code": code,
            "is_on_dragon_tiger": is_on_lhb,
            "dragon_tiger_reason": lhb_reason,
            "is_in_hot_concept": len(hot_concepts) > 0,
            "hot_concepts": hot_concepts,
            "is_new_high": is_new_high
        })

    return monitoring_data
```

---

## 🎯 优先级实施建议

### **Phase 1: MVP 核心（1-2周）**
- ✅ 大盘指数
- ✅ 市场成交与情绪（涨跌家数、涨跌比、连板分布）
- ✅ 涨跌停列表
- ✅ 龙虎榜基础数据

### **Phase 2: 增强功能（2-3周）**
- ⭐ 热门概念深度分析（龙头股识别）
- ⭐ 自选股监控（是否上榜、是否在热门概念）
- ⭐ 涨停炸板率统计

### **Phase 3: 高级功能（3-4周）**
- 🔥 机构/游资席位分析
- 🔥 营业部画像与成功率统计
- 🔥 概念强度评分
- 🔥 异动监控与提醒

---

## 📊 前端页面布局建议

```
┌─────────────────────────────────────────────────┐
│  📈 大盘指数区（3个指数+小K线）                    │
├───────────────┬─────────────────────────────────┤
│ 市场成交      │  市场情绪                         │
│ 总额: 8520亿  │  涨停: 45  跌停: 12                │
│ 沪市: 4200亿  │  涨跌比: 3.2                      │
│ 深市: 4320亿  │  炸板率: 15%                      │
│               │  连板分布: [2连:15 3连:8 4连:3]    │
├───────────────┴─────────────────────────────────┤
│  🔥 涨停板列表（可筛选、排序）                     │
│  ┌──────┬────┬────┬────┬───────┬────┐          │
│  │ 代码 │名称│涨幅│连板│首封时间│概念│          │
│  ├──────┼────┼────┼────┼───────┼────┤          │
│  │603777│来伊份│20%│ 3  │09:31  │AI  │          │
│  └──────┴────┴────┴────┴───────┴────┘          │
├─────────────────────────────────────────────────┤
│  🐉 龙虎榜（可展开查看席位详情）                   │
│  + 机构席位统计                                   │
│  + 游资席位排行                                   │
├─────────────────────────────────────────────────┤
│  🔥 热门概念板块（热力图）                        │
│  ┌───────┬─────┬────┬──────┐                   │
│  │ 概念  │ 涨幅 │龙头│强度  │                   │
│  ├───────┼─────┼────┼──────┤                   │
│  │ AI概念│+5.2%│科大│ 156  │                   │
│  └───────┴─────┴────┴──────┘                   │
├──────────────────��──────────────────────────────┤
│  ⭐ 自选股监控（高亮上榜+热门概念）                │
│  🔔 异动提醒                                     │
└─────────────────────────────────────────────────┘
```

---

## 📝 总结

根据截图需求，我们需要：

1. **补充6个核心数据表**
2. **增强13个数据采集接口**
3. **新增4个分析模块**（市场情绪、席位分析、概念深度、自选监控）

所有功能均可通过 **AKShare 免费接口** 实现，无需额外成本！
