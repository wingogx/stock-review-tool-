# 板块分析功能开发计划

## 📋 文档信息

- **版本**: v1.0
- **创建日期**: 2025-12-12
- **最后更新**: 2025-12-12
- **项目周期**: 预计3-5个工作日
- **负责人**: 短线复盘项目团队

---

## 1. 开发阶段划分

### Phase 1: 数据准备 (0.5天)
- ✅ 已完成: `hot_concepts` 表已存在
- 🔲 待确认: 数据范围是否覆盖TOP50

### Phase 2: 后端开发 (1天)
- 🔲 数据模型定义
- 🔲 API接口实现
- 🔲 单元测试
- 🔲 API文档更新

### Phase 3: 前端开发 (1.5天)
- 🔲 API客户端封装
- 🔲 页面布局开发
- 🔲 四个模块组件开发
- 🔲 样式优化

### Phase 4: 联调测试 (0.5天)
- 🔲 前后端联调
- 🔲 数据验证
- 🔲 性能测试

### Phase 5: 上线部署 (0.5天)
- 🔲 代码审查
- 🔲 生产部署
- 🔲 功能验收

---

## 2. 详细任务分解

### 2.1 Phase 1: 数据准备

#### 任务1.1: 确认数据范围
- **负责人**: 后端开发
- **时间**: 0.5天
- **任务内容**:
  1. 检查 `hot_concepts` 表当前存储的数据量
  2. 如果只有TOP10，修改 `HotConceptsCollector` 采集TOP50
  3. 重新采集历史数据(至少最近3天)
  4. 验证数据完整性

**验收标准**:
```sql
-- 每日应有50条概念板块数据
SELECT COUNT(*) FROM hot_concepts WHERE trade_date = '2025-12-12';
-- 期望结果: 50
```

**执行脚本**:
```bash
# 修改采集器
vim backend/app/services/collectors/hot_concepts_collector.py

# 重新采集
cd backend
./venv/bin/python3 -c "
from app.services.collectors.hot_concepts_collector import HotConceptsCollector
collector = HotConceptsCollector()
collector.collect_and_save(trade_date='2025-12-12')
"
```

---

### 2.2 Phase 2: 后端开发

#### 任务2.1: 定义数据模型
- **负责人**: 后端开发
- **时间**: 0.5天
- **文件**: `backend/app/schemas/concepts.py`

**任务清单**:
- [ ] 创建 `TrendSectorItem`
- [ ] 创建 `EmotionSectorItem`
- [ ] 创建 `MainSectorItem`
- [ ] 创建 `AnomalySectorItem`
- [ ] 创建 `SectorAnalysisData`
- [ ] 创建 `SectorAnalysisResponse`

**参考代码**: 见《技术手册》2.2节

---

#### 任务2.2: 实现API接口
- **负责人**: 后端开发
- **时间**: 1天
- **文件**: `backend/app/routers/concepts.py`

**任务清单**:
- [ ] 实现 `get_sector_analysis()` 函数
- [ ] 实现趋势板块查询逻辑
- [ ] 实现情绪板块筛选逻辑
- [ ] 实现主线板块交集计算
- [ ] 实现异动板块查询和去重
- [ ] 错误处理和日志记录

**核心逻辑**:

```python
# 1. 趋势板块
trend_sectors = sorted(
    [c for c in all_concepts if c.get('rank', 999) <= 6],
    key=lambda x: x.get('change_pct', 0),
    reverse=True
)[:6]

# 2. 情绪板块
emotion_sectors = sorted(
    [c for c in all_concepts
     if c.get('rank', 999) <= 10 and c.get('limit_up_count', 0) > 10],
    key=lambda x: x.get('limit_up_count', 0),
    reverse=True
)

# 3. 主线板块(交集)
trend_names = {s['concept_name'] for s in trend_sectors}
emotion_names = {s['concept_name'] for s in emotion_sectors}
main_names = trend_names & emotion_names
main_sectors = [c for c in trend_sectors if c['concept_name'] in main_names]

# 4. 异动板块(排除TOP10)
top10_names = [c['concept_name'] for c in all_concepts if c.get('rank', 999) <= 10]
non_top10 = [c for c in all_concepts if c['concept_name'] not in top10_names]

limit_up_top2 = sorted(non_top10, key=lambda x: x.get('limit_up_count', 0), reverse=True)[:2]
change_top2 = sorted(non_top10, key=lambda x: x.get('day_change_pct', 0), reverse=True)[:2]

# 去重合并
anomaly_dict = {}
for s in limit_up_top2:
    anomaly_dict[s['concept_name']] = {**s, 'anomaly_type': 'limit_up'}
for s in change_top2:
    if s['concept_name'] not in anomaly_dict:
        anomaly_dict[s['concept_name']] = {**s, 'anomaly_type': 'change_pct'}
anomaly_sectors = list(anomaly_dict.values())
```

**测试命令**:
```bash
# 启动后端
cd backend
uvicorn app.main:app --reload

# 测试API
curl http://localhost:8000/api/concepts/sector-analysis
```

**验收标准**:
- [ ] API返回200状态码
- [ ] 响应符合 `SectorAnalysisResponse` 格式
- [ ] 趋势板块≤6个
- [ ] 情绪板块全部涨停数>10
- [ ] 主线板块是趋势和情绪的交集
- [ ] 异动板块不在TOP10中

---

#### 任务2.3: 编写单元测试
- **负责人**: 后端开发
- **时间**: 0.5天
- **文件**: `backend/tests/test_sector_analysis.py`

**测试用例**:
```python
def test_trend_sectors_limit():
    """趋势板块不超过6个"""
    pass

def test_emotion_sectors_filter():
    """情绪板块涨停数>10"""
    pass

def test_main_sectors_intersection():
    """主线板块是交集"""
    pass

def test_anomaly_not_in_top10():
    """异动板块不在TOP10"""
    pass
```

**执行测试**:
```bash
pytest backend/tests/test_sector_analysis.py -v
```

---

### 2.3 Phase 3: 前端开发

#### 任务3.1: API客户端封装
- **负责人**: 前端开发
- **时间**: 0.5天
- **文件**: `frontend/lib/api.ts`

**任务清单**:
- [ ] 定义TypeScript类型
- [ ] 实现 `getSectorAnalysis()` 函数
- [ ] 配置缓存策略(5分钟)

**代码示例**: 见《技术手册》3.1节

---

#### 任务3.2: 页面布局开发
- **负责人**: 前端开发
- **时间**: 0.5天
- **文件**: `frontend/app/sector/page.tsx`

**任务清单**:
- [ ] 创建主页面组件
- [ ] 添加页面标题和日期显示
- [ ] 集成React Query数据获取
- [ ] 添加Loading状态
- [ ] 添加Error状态

**布局结构**:
```tsx
<div className="container mx-auto py-6 space-y-6">
  {/* 标题 */}
  <PageHeader />

  {/* 四个模块 */}
  <TrendSectorsCard />
  <EmotionSectorsCard />
  <MainSectorsCard />
  <AnomalySectorsCard />
</div>
```

---

#### 任务3.3: 四个模块组件开发
- **负责人**: 前端开发
- **时间**: 1.5天
- **文件**: `frontend/app/sector/components/`

**子任务**:

**3.3.1 趋势板块组件** (0.5天)
- [ ] 创建 `TrendSectorsCard.tsx`
- [ ] 表格布局(板块、当日涨幅、5日涨幅、龙头股)
- [ ] 颜色标记(红涨绿跌)
- [ ] 空状态处理

**3.3.2 情绪板块组件** (0.5天)
- [ ] 创建 `EmotionSectorsCard.tsx`
- [ ] 表格布局(板块、当日涨幅、涨停数、龙头股)
- [ ] 涨停数高亮显示
- [ ] 空状态处理

**3.3.3 主线板块组件** (0.5天)
- [ ] 创建 `MainSectorsCard.tsx`
- [ ] 表格布局(板块、当日涨幅、5日涨幅、涨停数、龙头股)
- [ ] 特殊标记(紫色主题)
- [ ] 空状态处理("暂无主线板块")

**3.3.4 异动板块组件** (0.5天)
- [ ] 创建 `AnomalySectorsCard.tsx`
- [ ] 表格布局(板块、当日涨幅、涨停数、龙头股)
- [ ] 异动类型标记(涨停异动/涨幅异动)
- [ ] 空状态处理

**通用组件**:
```tsx
// 空状态组件
function EmptyCard({ title }: { title: string }) {
  return (
    <Card>
      <CardHeader>
        <CardTitle>{title}</CardTitle>
      </CardHeader>
      <CardContent>
        <div className="text-center py-8 text-gray-500">
          暂无数据
        </div>
      </CardContent>
    </Card>
  );
}
```

---

#### 任务3.4: 样式优化
- **负责人**: 前端开发
- **时间**: 0.5天

**任务清单**:
- [ ] 响应式布局测试(桌面/平板/手机)
- [ ] 颜色对比度检查(可访问性)
- [ ] Hover效果优化
- [ ] Loading骨架屏
- [ ] 动画效果(可选)

**响应式断点**:
```css
/* 手机 */
@media (max-width: 640px) {
  /* 表格滚动 */
}

/* 平板 */
@media (min-width: 641px) and (max-width: 1024px) {
  /* 紧凑布局 */
}

/* 桌面 */
@media (min-width: 1025px) {
  /* 宽松布局 */
}
```

---

### 2.4 Phase 4: 联调测试

#### 任务4.1: 前后端联调
- **负责人**: 全栈开发
- **时间**: 0.5天

**测试场景**:

1. **正常场景**
   - [ ] 访问页面，数据正常加载
   - [ ] 四个模块数据准确
   - [ ] 日期显示正确

2. **边界场景**
   - [ ] 主线板块为空(无交集)
   - [ ] 异动板块为空(TOP10外无数据)
   - [ ] 情绪板块为空(无涨停>10)

3. **异常场景**
   - [ ] 后端服务挂掉
   - [ ] 网络超时
   - [ ] 数据格式错误

**测试工具**:
```bash
# 前端
npm run dev

# 后端
uvicorn app.main:app --reload

# 浏览器
http://localhost:3000/sector
```

---

#### 任务4.2: 数据验证
- **负责人**: 测试工程师
- **时间**: 0.5天

**验证清单**:

- [ ] **趋势板块验证**
  - 数量: 6个
  - 排序: 按5日涨幅降序
  - 字段: 板块名、当日涨幅、5日涨幅、龙头股

- [ ] **情绪板块验证**
  - 筛选: 全部涨停数>10
  - 排序: 按涨停数降序
  - 字段: 板块名、当日涨幅、涨停数、龙头股

- [ ] **主线板块验证**
  - 数量: ≤6(趋势和情绪交集)
  - 排序: 保持首页顺序
  - 字段: 板块名、当日涨幅、5日涨幅、涨停数、龙头股

- [ ] **异动板块验证**
  - 数量: 2-4个
  - 排除: 不在TOP10
  - 顺序: 涨停数前2在前，涨幅前2在后
  - 去重: 同一板块只出现一次

**验证方法**:
```python
# Python脚本验证
import requests

response = requests.get('http://localhost:8000/api/concepts/sector-analysis')
data = response.json()

# 验证趋势板块
assert len(data['data']['trend_sectors']) <= 6

# 验证情绪板块
for sector in data['data']['emotion_sectors']:
    assert sector['limit_up_count'] > 10

# 验证主线板块
trend_names = {s['concept_name'] for s in data['data']['trend_sectors']}
emotion_names = {s['concept_name'] for s in data['data']['emotion_sectors']}
main_names = {s['concept_name'] for s in data['data']['main_sectors']}
assert main_names == (trend_names & emotion_names)
```

---

#### 任务4.3: 性能测试
- **负责人**: 后端开发
- **时间**: 0.5天

**性能指标**:

| 指标 | 目标 | 测试方法 |
|------|------|---------|
| API响应时间 | <300ms | ab测试 |
| 数据库查询 | <100ms | 慢查询日志 |
| 页面加载 | <1s | Chrome DevTools |
| 并发能力 | 100 QPS | 压力测试 |

**测试命令**:
```bash
# 压力测试
ab -n 1000 -c 100 http://localhost:8000/api/concepts/sector-analysis

# 查询分析
EXPLAIN ANALYZE SELECT * FROM hot_concepts WHERE trade_date = '2025-12-12';
```

**优化方案**(如不达标):
- [ ] 添加数据库索引
- [ ] 启用响应缓存
- [ ] 优化SQL查询
- [ ] 使用连接池

---

### 2.5 Phase 5: 上线部署

#### 任务5.1: 代码审查
- **负责人**: 技术负责人
- **时间**: 0.5天

**审查清单**:
- [ ] 代码规范(PEP8 / Airbnb Style)
- [ ] 注释完整性
- [ ] 类型标注(TypeScript)
- [ ] 错误处理
- [ ] 日志记录
- [ ] 安全性检查(SQL注入、XSS)

**工具**:
```bash
# Python代码检查
flake8 backend/app/routers/concepts.py
mypy backend/app/routers/concepts.py

# TypeScript代码检查
npm run lint
npm run type-check
```

---

#### 任务5.2: 生产部署
- **负责人**: 运维工程师
- **时间**: 0.5天

**部署步骤**:

1. **后端部署**
   ```bash
   # 1. 拉取最新代码
   git pull origin main

   # 2. 安装依赖
   pip install -r requirements.txt

   # 3. 数据库迁移(如有)
   # alembic upgrade head

   # 4. 重启服务
   systemctl restart fastapi.service
   ```

2. **前端部署**
   ```bash
   # 1. 构建生产版本
   npm run build

   # 2. 部署到Vercel
   vercel --prod

   # 或部署到Nginx
   cp -r .next /var/www/html/
   systemctl reload nginx
   ```

3. **数据库优化**
   ```sql
   -- 添加索引
   CREATE INDEX idx_hot_concepts_date_rank
   ON hot_concepts(trade_date, rank);

   CREATE INDEX idx_hot_concepts_date_limit
   ON hot_concepts(trade_date, limit_up_count DESC);
   ```

4. **验证部署**
   ```bash
   # 测试API
   curl https://api.yourapp.com/api/concepts/sector-analysis

   # 测试前端
   curl https://yourapp.com/sector
   ```

---

#### 任务5.3: 功能验收
- **负责人**: 产品经理
- **时间**: 0.5天

**验收标准**: 见《需求文档》第7节

**验收流程**:
1. [ ] 功能测试(四个模块正确显示)
2. [ ] 界面测试(布局、颜色、响应式)
3. [ ] 数据准确性测试(抽查3个交易日数据)
4. [ ] 性能测试(页面加载<1s)
5. [ ] 兼容性测试(Chrome/Safari/Edge)
6. [ ] 移动端测试(iOS/Android)

**验收通过**: 签字确认，正式上线

---

## 3. 风险管理

### 3.1 数据风险

**风险**: `hot_concepts` 表只存储TOP10数据，异动板块无法实现

**应对**:
- [ ] 优先确认数据范围(Phase 1任务1.1)
- [ ] 如不足，立即修改采集器
- [ ] 重新采集至少3天数据

**责任人**: 后端开发
**截止时间**: Phase 1结束前

---

### 3.2 性能风险

**风险**: 查询50条数据+复杂计算，API响应可能超时

**应对**:
- [ ] 添加数据库索引
- [ ] 查询结果缓存(5分钟)
- [ ] 考虑预计算(定时任务)

**责任人**: 后端开发
**监控指标**: API响应时间 < 300ms

---

### 3.3 需求变更风险

**风险**: 开发过程中需求变更

**应对**:
- [ ] 锁定核心需求(四个模块定义)
- [ ] 预留扩展接口(板块详情页)
- [ ] 版本控制(v1.0只做基础功能)

**责任人**: 产品经理
**变更流程**: 评审 → 影响分析 → 时间调整

---

## 4. 质量保证

### 4.1 代码质量

**标准**:
- [ ] 单元测试覆盖率 > 80%
- [ ] 代码注释率 > 30%
- [ ] 无Critical/High级别Bug

**工具**:
- pytest (后端测试)
- Jest (前端测试)
- Coverage.py (覆盖率)

---

### 4.2 文档质量

**必备文档**:
- [x] 需求文档
- [x] 技术手册
- [x] 开发计划
- [ ] API文档(Swagger自动生成)
- [ ] 用户手册(可选)

---

### 4.3 用户体验

**检查点**:
- [ ] 页面加载<1s
- [ ] 无明显卡顿
- [ ] 空状态友好提示
- [ ] 错误提示清晰
- [ ] 移动端适配良好

---

## 5. 时间进度表

### 5.1 甘特图

```
任务                  Day1  Day2  Day3  Day4  Day5
────────────────────  ────  ────  ────  ────  ────
Phase1: 数据准备      ████
Phase2: 后端开发      ████  ████
Phase3: 前端开发            ████  ████  ██
Phase4: 联调测试                        ████
Phase5: 上线部署                              ████
```

### 5.2 里程碑

| 里程碑 | 日期 | 交付物 | 状态 |
|--------|------|--------|------|
| M1: 数据准备完成 | Day1 | TOP50数据就绪 | 🔲 |
| M2: 后端开发完成 | Day2 | API可用 | 🔲 |
| M3: 前端开发完成 | Day4 | 页面可访问 | 🔲 |
| M4: 测试完成 | Day4 | 测试报告 | 🔲 |
| M5: 上线完成 | Day5 | 生产环境可用 | 🔲 |

---

## 6. 资源需求

### 6.1 人力资源

| 角色 | 人数 | 工作量 | 备注 |
|------|------|--------|------|
| 后端开发 | 1 | 2天 | Python/FastAPI |
| 前端开发 | 1 | 2天 | React/Next.js |
| 测试工程师 | 1 | 1天 | 可兼任 |
| 运维工程师 | 1 | 0.5天 | 部署阶段 |
| 产品经理 | 1 | 0.5天 | 验收阶段 |

### 6.2 技术资源

- [ ] Supabase数据库(已有)
- [ ] Tushare Pro API(已有)
- [ ] Vercel部署账号(已有)
- [ ] 测试服务器(本地开发机)

---

## 7. 沟通计划

### 7.1 日常沟通

- **每日站会**: 15分钟
  - 昨日完成
  - 今日计划
  - 遇到问题

- **技术讨论**: 随时
  - Slack/微信群
  - 代码Review

### 7.2 阶段汇报

- **Phase完成**: 发送邮件总结
  - 完成情况
  - 遇到问题
  - 下一步计划

---

## 8. 验收标准

### 8.1 功能验收

参见《需求文档》第7节验收标准

### 8.2 技术验收

- [ ] 单元测试全部通过
- [ ] 集成测试全部通过
- [ ] 性能测试达标
- [ ] 代码审查通过
- [ ] 文档完整

### 8.3 上线验收

- [ ] 生产环境部署成功
- [ ] 监控告警正常
- [ ] 数据准确性验证
- [ ] 用户体验符合预期

---

## 9. 后续维护

### 9.1 监控指标

- API错误率 < 0.1%
- API响应时间 < 300ms
- 页面加载时间 < 1s
- 数据更新及时性 < 5分钟

### 9.2 迭代计划

**v1.1** (1个月后):
- 板块详情页
- 成分股列表
- K线图展示

**v1.2** (2个月后):
- 板块资金流向
- 板块历史表现
- 板块对比功能

---

## 10. 附录

### 10.1 参考文档

- 《板块分析需求文档》
- 《板块分析技术手册》
- 《数据采集架构设计》
- 《交易日日历说明》

### 10.2 联系人

| 角色 | 姓名 | 联系方式 |
|------|------|---------|
| 项目经理 | - | - |
| 后端负责人 | - | - |
| 前端负责人 | - | - |
| 测试负责人 | - | - |

---

## 11. 变更记录

| 版本 | 日期 | 修改内容 | 修改人 |
|------|------|---------|--------|
| v1.0 | 2025-12-12 | 初始版本 | 项目组 |

---

**文档状态**: ✅ 已完成
**批准状态**: 待批准
**维护者**: 短线复盘项目团队

---

## 开始开发前检查清单

在开始开发前，请确认以下事项：

- [ ] 已阅读需求文档
- [ ] 已阅读技术手册
- [ ] 已理解开发计划
- [ ] 已确认数据范围(TOP50)
- [ ] 开发环境已搭建
- [ ] 数据库连接正常
- [ ] 代码仓库权限已开通
- [ ] 所有依赖已安装

**确认人**: ____________
**日期**: ____________

---

**开发愉快！** 🚀
