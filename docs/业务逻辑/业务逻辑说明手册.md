# 短线复盘工具 - 业务逻辑说明手册

**文档版本**: v2.8
**创建日期**: 2025-12-10
**最后更新**: 2025-12-13

---

## 目录

1. [市场情绪评分系统](#1-市场情绪评分系统)
2. [涨跌停判断逻辑](#2-涨跌停判断逻辑)
3. [炸板率计算逻辑](#3-炸板率计算逻辑)
4. [连板分布统计](#4-连板分布统计)
5. [主力资金流向](#5-主力资金流向)
6. [情绪周期阶段判断（v2.0）](#6-情绪周期阶段判断v20)
7. [板块分析四大模块](#7-板块分析四大模块)
8. [大盘指数走势判断](#8-大盘指数走势判断)
9. [高标梯队分析](#9-高标梯队分析)
10. [龙头股深度分析](#10-龙头股深度分析)
11. [个股明日溢价概率评分模型（v2.0）](#11-个股明日溢价概率评分模型v20)

---

## 1. 市场情绪评分系统

### 1.1 设计目标

通过多维度指标综合评估当日市场情绪，帮助短线交易者判断市场环境是否适合操作。

### 1.2 评分指标

系统采用5个核心指标进行综合评分：

| 指标 | 权重 | 说明 |
|------|------|------|
| 上涨占比 | 1 | 全市场上涨股票数量占比 |
| 成交额变化 | 1 | 与上一交易日成交额对比变化率 |
| 涨停数 | 1 | 当日涨停数量（绝对数量，参考市场通用标准） |
| 跌停数 | 1 | 当日跌停数量（绝对数量，参考市场通用标准） |
| 炸板率 | 1 | 当日炸板数/(涨停数+炸板数) |

### 1.3 单项评分规则

#### 1.3.1 上涨占比

```
上涨占比 = 上涨股票数 / (上涨股票数 + 下跌股票数) × 100%
```

| 条件 | 得分 | 说明 |
|------|------|------|
| > 50% | +1 | 多数股票上涨，市场偏强 |
| 30% ~ 50% | 0 | 涨跌参半，市场中性 |
| < 30% | -1 | 多数股票下跌，市场偏弱 |

#### 1.3.2 成交额变化

```
成交额变化率 = (今日成交额 - 昨日成交额) / 昨日成交额 × 100%
```

| 条件 | 得分 | 说明 |
|------|------|------|
| > +10% | +1 | 明显放量，资金活跃 |
| -10% ~ +10% | 0 | 成交平稳 |
| < -10% | -1 | 明显缩量，资金观望 |

#### 1.3.3 涨停数（绝对数量）

基于市场通用标准，按当日涨停数量的绝对值评分：

| 条件 | 得分 | 说明 |
|------|------|------|
| ≥ 100只 | +1 | 市场强势，做多热情高涨 |
| 50 ~ 99只 | 0 | 市场正常，涨停数适中 |
| < 50只 | -1 | 市场弱势，情绪不佳 |

**标准来源**：A股市场通用标准（主板涨停<50只为弱势，>100只为强势）

#### 1.3.4 跌停数（绝对数量）

基于市场通用标准，按当日跌停数量的绝对值评分：

| 条件 | 得分 | 说明 |
|------|------|------|
| ≤ 5只 | +1 | 恐慌情绪低，市场健康 |
| 6 ~ 15只 | 0 | 跌停数正常，市场中性 |
| > 15只 | -1 | 恐慌情绪蔓延，风险较高 |

**标准来源**：A股市场通用标准（跌停≤5只为情绪高涨期，>15只为恐慌期）

#### 1.3.5 炸板率

```
炸板率 = 炸板数 / (涨停数 + 炸板数) × 100%
```

| 条件 | 得分 | 说明 |
|------|------|------|
| < 20% | +1 | 封板强度高，资金承接力强 |
| 20% ~ 30% | 0 | 封板强度正常 |
| > 30% | -1 | 封板强度弱，追高风险大 |

### 1.4 综合评分与情绪等级

**总分范围**: -5 ~ +5

| 总分 | 情绪等级 | 颜色标识 | 操作建议 |
|------|---------|---------|---------|
| +4 ~ +5 | 极度亢奋 | 🔴 深红 | 注意高位风险 |
| +2 ~ +3 | 情绪偏热 | 🟠 橙色 | 可积极参与 |
| +1 | 情绪偏暖 | 🟡 黄色 | 可适度参与 |
| 0 | 情绪中性 | ⚪ 灰色 | 观望为主 |
| -1 | 情绪偏冷 | 🟡 黄色 | 谨慎参与 |
| -2 ~ -3 | 情绪偏弱 | 🔵 蓝色 | 控制仓位 |
| -4 ~ -5 | 极度冰点 | 🟢 绿色 | 空仓观望 |

### 1.5 计算示例

以 2025-12-12 数据为例：

| 指标 | 数据 | 计算过程 | 得分 |
|------|------|---------|------|
| 上涨占比 | 2683涨 / 2612跌 | 50.7% > 50% | +1 |
| 成交额变化 | 21190亿 vs 昨日18853亿 | +12.4% > +10% | +1 |
| 涨停数 | 78只 | 50 ≤ 78 < 100，正常水平 | 0 |
| 跌停数 | 15只 | 6 ≤ 15 ≤ 15，正常水平 | 0 |
| 炸板率 | 13.3% | < 20% | +1 |
| **总分** | | | **+3** |

**结论**: 情绪偏热 🟠，可积极参与

---

**对比说明**：旧规则基于涨跌停数的"环比变化"评分，容易出现假信号。例如昨日涨停34只、今日78只，旧规则因"增加"直接给+1分，但78只在市场整体来看只是正常水平，不应加分。新规则基于绝对数量评分，更客观反映市场真实情绪。

---

## 2. 涨跌停判断逻辑

### 2.1 涨停判断

```
普通股票涨停价 = 前收盘价 × 1.10（四舍五入到分）
ST股票涨停价 = 前收盘价 × 1.05（四舍五入到分）
```

**涨停条件**: 当前价格 = 涨停价 且 有封单

### 2.2 跌停判断

```
普通股票跌停价 = 前收盘价 × 0.90（四舍五入到分）
ST股票跌停价 = 前收盘价 × 0.95（四舍五入到分）
```

**跌停条件**: 当前价格 = 跌停价 且 有封单

### 2.3 数据来源

使用 AKShare `stock_zt_pool_em` 接口获取涨停池数据，已包含涨停判断。

---

## 3. 炸板率计算逻辑

### 3.1 定义

**炸板**: 股票盘中触及涨停价后，封单被打开，收盘未能封住涨停。

### 3.2 计算公式

```
炸板率 = 炸板数 / (最终涨停数 + 炸板数) × 100%
```

**说明**:
- 分母是"曾经涨停的股票总数"
- 最终涨停数：收盘时封住涨停的股票数量
- 炸板数：盘中涨停但收盘未封住的股票数量

### 3.3 数据来源

- 涨停数：`stock_zt_pool_em` 接口
- 炸板数：`stock_zt_pool_zbgc_em` 接口（炸板股池）

### 3.4 参考阈值

| 炸板率 | 市场含义 |
|--------|---------|
| < 15% | 封板强度极高，市场承接力强 |
| 15% ~ 25% | 封板强度正常 |
| 25% ~ 35% | 封板强度偏弱，追高有风险 |
| > 35% | 封板强度很弱，追涨停风险大 |

---

## 4. 连板分布统计

### 4.1 定义

**连板**: 股票连续多个交易日涨停。

- 首板：当日首次涨停（连续涨停天数=1）
- 2连板：连续2个交易日涨停
- 3连板：连续3个交易日涨停
- ...以此类推

### 4.2 统计维度

```json
{
  "1": 35,   // 首板股票数量
  "2": 10,   // 2连板数量
  "3": 5,    // 3连板数量
  "4": 2,    // 4连板数量
  "5+": 1    // 5板及以上数量
}
```

### 4.3 市场含义

- **首板数量多**: 市场活跃，新题材涌现
- **高度板存在**: 市场有龙头效应，情绪延续性好
- **断层明显**: 如首板多但2板少，说明晋级率低，追高风险大

---

## 5. 主力资金流向

### 5.1 定义

**主力资金** = 超大单 + 大单

- 超大单：单笔成交金额 > 100万
- 大单：单笔成交金额 20万 ~ 100万
- 中单：单笔成交金额 4万 ~ 20万
- 小单：单笔成交金额 < 4万

### 5.2 字段说明

| 字段 | 说明 | 单位 |
|------|------|------|
| main_net_inflow | 主力净流入金额 | 元 |
| main_net_inflow_pct | 主力净流入占比 | % |

### 5.3 计算公式

```
主力净流入 = 主力买入金额 - 主力卖出金额
主力净流入占比 = 主力净流入 / 当日成交额 × 100%
```

### 5.4 参考意义

| 情况 | 含义 |
|------|------|
| 净流入 > 0 | 主力资金买入为主，看好后市 |
| 净流入 < 0 | 主力资金卖出为主，可能出货 |
| 占比 > 10% | 主力介入程度高 |
| 占比 < -10% | 主力出货明显 |

### 5.5 数据来源

AKShare `stock_individual_fund_flow` 接口，按股票代码和日期查询。

---

## 6. 情绪周期阶段判断（v2.2）

### 6.1 设计目标

通过多因子梯度打分，综合判断当前市场所处的情绪周期阶段，帮助交易者判断市场环境。

### 6.2 情绪周期五阶段

| 阶段 | 颜色 | 特征描述 | 操作建议 |
|------|------|---------|---------|
| 冰点期 | 🔵 蓝色 | 市场极度低迷，涨停少，炸板多，亏钱效应明显 | 空仓观望，等待转机 |
| 回暖期 | 🟡 黄色 | 市场开始回暖，尝试性赚钱，分歧较大 | 轻仓试错，关注新龙头 |
| 加速期 | 🟠 橙色 | 市场情绪升温，龙头确立，跟风股活跃 | 可积极参与，顺势而为 |
| 高潮期 | 🔴 红色 | 市场极度亢奋，一致性高，风险累积 | 注意高位风险，逐步兑现 |
| 退潮期 | 🟢 绿色 | 高位见顶回落，大面股增多，亏钱效应出现 | 减仓避险，等待冰点 |

### 6.3 数据来源

#### 6.3.1 基础数据表

| 数据表 | 说明 | 采集频率 |
|--------|------|---------|
| `market_sentiment` | 市场情绪数据（涨停数、炸板率、连板分布等） | 每日15:30后 |
| `limit_stocks_detail` | 涨停股明细（连板数、封板时间等） | 每日15:30后 |
| `yesterday_limit_performance` | 昨日涨停股今日表现 | 每日15:30后 |

#### 6.3.2 昨日涨停表现数据采集

**采集逻辑**：
1. 从 `limit_stocks_detail` 获取昨日所有涨停股
2. 通过 Tushare `daily` 接口获取这些股票今日行情
3. 计算各项指标并写入 `yesterday_limit_performance` 表

**数据字段**：

| 字段 | 类型 | 说明 |
|------|------|------|
| trade_date | DATE | 今日日期（表现日期） |
| stock_code | VARCHAR | 股票代码 |
| stock_name | VARCHAR | 股票名称 |
| yesterday_continuous_days | INT | 昨日连板数（1=首板，2=2连板...） |
| yesterday_is_strong_limit | BOOLEAN | 昨日是否一字板 |
| today_open_pct | DECIMAL | 今日开盘涨幅（集合竞价溢价） |
| today_change_pct | DECIMAL | 今日涨跌幅 |
| today_high_pct | DECIMAL | 今日最高涨幅 |
| today_low_pct | DECIMAL | 今日最低涨幅 |
| today_amount | DECIMAL | 今日成交额 |
| is_limit_up | BOOLEAN | 今日是否涨停（晋级成功） |
| is_limit_down | BOOLEAN | 今日是否跌停 |
| is_big_loss | BOOLEAN | 是否大面（跌幅>5%） |
| is_big_high | BOOLEAN | 是否大涨（涨幅>5%但未涨停） |

### 6.4 核心指标定义

#### 6.4.1 空间板高度 (space_height)

**定义**：当日市场最高连板数

**计算**：
```python
space_height = max(连板分布字典的key值)
```

**意义**：
- ≤2板：市场冰点，无高度
- 3-4板：市场回暖中
- 5-6板：市场加速中
- ≥7板：市场高潮期

#### 6.4.2 涨停数 (limit_up_count)

**定义**：当日收盘涨停的股票数量

**意义**：
- <20家：市场冰点
- 20-60家：正常水平
- ≥80家：市场高潮

#### 6.4.3 炸板率 (explosion_rate)

**定义**：盘中涨停但收盘未封住的比例

**计算**：
```python
炸板率 = 炸板数 / (涨停数 + 炸板数) × 100%
```

**意义**：
- <15%：封板强度极高
- 15-25%：正常水平
- 25-40%：封板偏弱
- >40%：封板很弱，追高风险大
- >50%：极度弱势

#### 6.4.4 昨日涨停溢价率 (avg_premium)

**定义**：昨日涨停股今日的平均涨跌幅

**计算**：
```python
avg_premium = sum(昨日涨停股今日涨跌幅) / 昨日涨停股数量
```

**意义**：
- >+3%：打板赚钱效应极好
- +1%~+3%：赚钱效应好
- -1%~+1%：持平
- -3%~-1%：亏钱效应
- <-3%：亏钱效应严重

#### 6.4.5 大面率 (big_loss_rate)

**定义**：昨日涨停股中今日跌幅超过5%的比例

**计算**：
```python
大面率 = 大面股数量 / 昨日涨停股数量 × 100%
```

**大面判断标准**：
```python
is_big_loss = today_change_pct <= -5%  # 当前采用标准
```

**备选标准**（可配置）：

| 标准 | 阈值 | 说明 |
|------|------|------|
| 宽松 | 跌幅 > 5% | 当前采用 |
| 严格 | 跌幅 > 7% | 接近跌停 |
| 最严格 | 跌停 | 只统计跌停 |

**意义**：
- <10%：昨日涨停股表现好
- 10-20%：正常水平
- 20-30%：有一定风险
- 30-40%：风险较高
- >40%：大面率极高，市场恐慌

#### 6.4.6 高位大面率 (high_board_big_loss_rate)

**定义**：昨日3连板及以上股票中，今日跌幅超过5%的比例

**计算**：
```python
高位股集合 = {昨日连板数 >= 3 的股票}
高位大面率 = 高位股中大面数 / 高位股数量 × 100%
```

**意义**：
- <15%：高位股安全
- 15-30%：有一定风险
- 30-50%：高位风险大
- >50%：高位股集体崩塌，退潮信号

#### 6.4.7 晋级率 (promotion_rate)

**定义**：昨日N板股票中，今日成功晋级到N+1板的比例

**计算**：
```python
N板晋级率 = 今日(N+1)板数量 / 昨日N板数量 × 100%
```

**意义**：
- >60%：晋级意愿强，接力活跃
- 40-60%：正常水平
- 20-40%：晋级困难
- <20%：晋级率极低，接力冰点

### 6.5 因子梯度打分算法

#### 6.5.1 打分原则

每个因子根据数值范围打分，分值范围 **-2 到 +2**：
- **+2**：极度利好
- **+1**：偏利好
- **0**：中性
- **-1**：偏利空
- **-2**：极度利空

#### 6.5.2 因子打分表（v2.2 共8因子）

| 因子 | -2 | -1 | 0 | +1 | +2 |
|------|----|----|---|----|----|
| 空间板高度 | ≤2 | 3-4 | - | 5-6 | ≥7 |
| 涨停数 | <10 | 10-29 | 30-69 | 70-89 | ≥90 |
| 跌停数（反向） | ≥50 | 30-49 | 10-29 | 1-9 | 0 |
| 炸板率（反向） | >50% | 35-50% | 25-35% | 15-25% | <15% |
| 溢价率 | <-3% | -3%~-1% | -1%~+1% | +1%~+3% | >+3% |
| 大面率（反向） | >40% | 30-40% | 20-30% | 10-20% | <10% |
| 高位大面率（反向） | >50% | 30-50% | 15-30% | <15% | - |
| 晋级率 | <15% | 15-25% | 25-50% | 50-60% | >60% |

**注意**：
- 跌停数因子是v2.2新增的
- 跌停数=0时得分为+1（而非+2），避免高估无跌停的情况
- 涨停数、炸板率、晋级率阈值已根据实际市场分布优化

#### 6.5.3 打分代码逻辑（v2.2）

```python
# 空间板高度：≤2=-2, 3-4=-1, 5-6=+1, ≥7=+2
if space_height <= 2:
    score = -2
elif space_height <= 4:
    score = -1
elif space_height <= 6:
    score = +1
else:  # >= 7
    score = +2

# 涨停数：<10=-2, 10-29=-1, 30-69=0, 70-89=+1, ≥90=+2
if limit_up_count < 10:
    score = -2
elif limit_up_count < 30:
    score = -1
elif limit_up_count < 70:
    score = 0
elif limit_up_count < 90:
    score = +1
else:  # >= 90
    score = +2

# 跌停数（反向）：≥50=-2, 30-49=-1, 10-29=0, 1-9=+1, =0=+1
if limit_down_count >= 50:
    score = -2
elif limit_down_count >= 30:
    score = -1
elif limit_down_count >= 10:
    score = 0
elif limit_down_count >= 1:
    score = +1
else:  # = 0
    score = +1  # 注意：0也是+1，避免高估

# 炸板率（反向）：>50%=-2, 35-50%=-1, 25-35%=0, 15-25%=+1, <15%=+2
if explosion_rate > 50:
    score = -2
elif explosion_rate > 35:
    score = -1
elif explosion_rate > 25:
    score = 0
elif explosion_rate > 15:
    score = +1
else:  # <= 15
    score = +2

# 溢价率：<-3%=-2, -3~-1%=-1, -1~+1%=0, +1~+3%=+1, >+3%=+2
if avg_premium < -3:
    score = -2
elif avg_premium < -1:
    score = -1
elif avg_premium < 1:
    score = 0
elif avg_premium < 3:
    score = +1
else:  # >= 3
    score = +2

# 大面率（反向）：>40%=-2, 30-40%=-1, 20-30%=0, 10-20%=+1, <10%=+2
if big_loss_rate > 40:
    score = -2
elif big_loss_rate > 30:
    score = -1
elif big_loss_rate > 20:
    score = 0
elif big_loss_rate > 10:
    score = +1
else:  # <= 10
    score = +2

# 高位大面率（反向）：>50%=-2, 30-50%=-1, 15-30%=0, <15%=+1
if high_board_big_loss_rate > 50:
    score = -2
elif high_board_big_loss_rate > 30:
    score = -1
elif high_board_big_loss_rate > 15:
    score = 0
else:  # <= 15
    score = +1

# 晋级率：<15%=-2, 15-25%=-1, 25-50%=0, 50-60%=+1, >60%=+2
if promotion_rate < 15:
    score = -2
elif promotion_rate < 25:
    score = -1
elif promotion_rate < 50:
    score = 0
elif promotion_rate < 60:
    score = +1
else:  # >= 60
    score = +2
```

### 6.6 总分映射阶段

#### 6.6.1 总分计算

```python
总分 = Σ(各因子得分)
# v2.2: 8个因子，理论范围：-16 到 +15
# （高位大面率最高+1，晋级率最低-2）
```

#### 6.6.2 阶段映射规则（v2.2）

| 总分范围 | 情绪阶段 | 说明 |
|---------|---------|------|
| S ≤ -6 | 冰点期 | 多个因子极度利空 |
| -6 < S ≤ 0 | 回暖期 | 整体偏弱但有改善 |
| 0 < S ≤ 6 | 加速期 | 整体偏强 |
| S > 6 | 高潮期 | 多个因子极度利好 |

**v2.2调整说明**：8个因子最高得分16分，阈值从±5调整为±6，更合理地划分阶段区间

#### 6.6.3 退潮期特殊判断

**退潮期不由总分直接判断**，需满足以下条件：

1. **前置条件**：最近3天内曾出现过加速期或高潮期
   ```python
   had_recent_peak = any(stage in ["加速期", "高潮期"] for stage in recent_3_days_stages)
   ```

2. **恶化信号**：当前市场正在恶化
   ```python
   is_deteriorating = (
       big_loss_rate > 25% and      # 大面率上升
       avg_premium < 0 and          # 溢价转负
       space_height >= 4            # 还没跌到冰点水平（v2.2：从≥3改为≥4，更严谨）
   )
   ```

3. **总分为负**：
   ```python
   total_score < 0
   ```

**判断逻辑**（v2.2）：
```python
if had_recent_peak and is_deteriorating and total_score < 0:
    stage = "退潮期"
elif total_score <= -6:
    stage = "冰点期"
elif total_score <= 0:
    stage = "回暖期"
elif total_score <= 6:
    stage = "加速期"
else:
    stage = "高潮期"
```

#### 6.6.4 惯性区间机制（v2.3）

**设计目的**：减少边界附近的频繁切换，让信号更稳定，同时保持对明显变化的快速响应。

**边界值**：`-6, 0, 6`

**惯性区间**：边界 ±1 范围内沿用昨日阶段

| 边界 | 惯性区间 | 说明 |
|------|---------|------|
| -6（冰点↔回暖） | -7 ~ -5 | 此范围内沿用昨日阶段 |
| 0（回暖↔加速） | -1 ~ 1 | 此范围内沿用昨日阶段 |
| 6（加速↔高潮） | 5 ~ 7 | 此范围内沿用昨日阶段 |

**判断逻辑**：
```python
# 1. 计算今日原始阶段
stage_raw = get_stage_by_score(total_score)

# 2. 获取昨日阶段
stage_prev = get_yesterday_stage()

# 3. 惯性判断
if stage_raw == stage_prev:
    stage = stage_prev  # 相同，不变
else:
    # 检查是否在边界±1范围内
    boundaries = [-6, 0, 6]
    in_inertia_zone = any(abs(total_score - b) <= 1 for b in boundaries)

    if in_inertia_zone:
        stage = stage_prev  # 在惯性区间，沿用昨日
    else:
        stage = stage_raw   # 明显跨越，立即切换
```

**效果示例**：
- 总分从 0.5 变到 -0.5 → 阶段不切换（在0的惯性区间内）
- 总分从 3 变到 -4 → 立即切换到回暖期（明显恶化）
- 总分从 6 变到 5 → 阶段不切换（在6的惯性区间内）
- 总分从 6 变到 2 → 立即切换到加速期（明显回落）

**优势**：
1. 过滤边界抖动，信号更清晰
2. 明显变化时依然快速响应
3. 适合超短线玩家：大趋势能跟上，边缘抖动被压住

### 6.7 计算示例

以 2025-12-12 数据为例（v2.2逻辑）：

#### 6.7.1 原始指标

| 指标 | 数值 |
|------|------|
| 空间板高度 | 6板 |
| 涨停数 | 78家 |
| 跌停数 | 15家 |
| 炸板率 | 13.3% |
| 整体溢价率 | +1.25% |
| 大面率 | 5.1% |
| 高位大面率 | 0% |
| 晋级率 | 28.6% |

#### 6.7.2 因子得分（v2.2）

| 因子 | 原始值 | 落入区间 | 得分 |
|------|--------|---------|------|
| 空间板 | 6板 | 5-6 | +1 |
| 涨停数 | 78家 | 70-89 | +1 |
| 跌停数 | 15家 | 10-29 | 0 |
| 炸板率 | 13.3% | <15% | +2 |
| 溢价率 | +1.25% | +1~+3% | +1 |
| 大面率 | 5.1% | <10% | +2 |
| 高位大面 | 0% | <15% | +1 |
| 晋级率 | 28.6% | 25-50% | 0 |

#### 6.7.3 总分与阶段

```
总分 = (+1) + (+1) + (0) + (+2) + (+1) + (+2) + (+1) + (0) = 8
总分区间：8 > 6 → 高潮期
```

#### 6.7.4 退潮判断

```
虽然近期有加速/高潮，但：
- big_loss_rate(5.1%) > 25%? ❌
- avg_premium(+1.25%) < 0? ❌
- 条件不满足，不触发退潮
```

**结论**：高潮期 🔴

### 6.8 相关代码位置

| 逻辑 | 文件路径 |
|------|---------|
| 昨日涨停表现采集 | `backend/app/services/collectors/yesterday_limit_collector.py` |
| 情绪阶段判断 | `backend/app/services/sentiment_service.py` → `_determine_emotion_stage()` |
| 最近阶段获取 | `backend/app/services/sentiment_service.py` → `_get_recent_stages()` |
| 溢价统计计算 | `backend/app/services/sentiment_service.py` → `_get_yesterday_limit_premium_stats()` |
| 前端展示 | `frontend/app/sentiment/page.tsx` → `EmotionDashboardCard` |

### 6.9 后续优化方向

1. **阈值动态化**：用历史分位数替代固定阈值，适应不同市场环境
2. **阶段惯性**：边界模糊时沿用前一日阶段，减少抖动
3. **因子权重**：根据回测结果调整各因子权重
4. **大面标准可配置**：支持5%/7%/跌停多种标准

---

## 7. 板块分析四大模块

### 7.1 设计目标

将概念板块按照不同维度进行分类和分析，帮助交易者快速识别市场主线、情绪和潜在机会。

### 7.2 数据来源

#### 7.2.1 概念板块数据采集

**数据源优先级**:
1. **Tushare**（优先）- 同花顺板块日行情接口，概念名称统一，可计算5日涨幅
2. **AKShare 同花顺**（备用）- 免费，数据丰富
3. **AKShare 东方财富**（备用）- 免费，实时性好

**采集流程**:
1. 获取所有概念板块数据（Tushare约409个）
2. 计算每个概念的5日涨幅
3. 通过 `ths_member` 接口获取成分股
4. 匹配涨停池计算涨停数
5. 计算龙头股

#### 7.2.2 核心数据表

| 数据表 | 说明 |
|--------|------|
| `hot_concepts` | 热门概念板块数据，包含异动标记 |
| `limit_stocks_detail` | 涨停股明细，用于计算概念涨停数 |

#### 7.2.3 关键字段

| 字段 | 类型 | 说明 |
|------|------|------|
| concept_name | VARCHAR | 概念名称 |
| day_change_pct | DECIMAL | 当日涨幅(%) |
| change_pct | DECIMAL | 5日累计涨幅(%) |
| limit_up_count | INT | 概念内涨停股数量 |
| leader_stock_code | VARCHAR | 龙头股代码 |
| leader_stock_name | VARCHAR | 龙头股名称 |
| leader_continuous_days | INT | 龙头股连板数 |
| is_anomaly | BOOLEAN | 是否为异动板块 |
| anomaly_type | VARCHAR | 异动类型：limit_up / change_pct |
| rank | INT | 排名 |

### 7.3 四大模块定义

#### 7.3.1 趋势板块

**定义**: 首页热门板块TOP10（按5日涨幅排序展示）

**筛选规则**:
```python
# 热门板块TOP10全部作为趋势板块，按5日涨幅排序展示
trend_sectors = sorted(hot_concepts, key=lambda x: x['change_pct'], reverse=True)
```

**意义**: 代表近期持续走强的题材方向，适合趋势跟踪

#### 7.3.2 情绪板块

**定义**: 首页热门板块中涨停股数量超过阈值的板块

**筛选规则**:
```python
EMOTION_LIMIT_UP_THRESHOLD = 10  # 涨停数阈值

# 从热门板块中筛选涨停数>10的板块
emotion_sectors = [c for c in hot_concepts if c['limit_up_count'] > 10]
emotion_sectors = sorted(emotion_sectors, key=lambda x: x['limit_up_count'], reverse=True)
```

**意义**: 代表当日资金活跃度高的题材，短线关注度高

#### 7.3.3 主线板块

**定义**: 趋势板块与情绪板块的交集

**筛选规则**:
```python
# 计算交集
trend_names = {s.concept_name for s in trend_sectors}
emotion_names = {s.concept_name for s in emotion_sectors}
main_names = trend_names & emotion_names

# 保持趋势排序
main_sectors = [c for c in trend_sectors if c['concept_name'] in main_names]
```

**意义**: 既有持续性又有活跃度的核心题材，是最值得关注的主线方向

#### 7.3.4 异动板块

**定义**: 不在首页热门TOP10中，但某项指标表现突出的板块

**筛选规则**:

1. **涨停异动** (`anomaly_type='limit_up'`):
   - 涨停数>10
   - 不在TOP10热门板块中
   - 按涨停数降序排列

2. **涨幅异动** (`anomaly_type='change_pct'`):
   - 当日涨幅前2名
   - 不在TOP10热门板块中
   - 不与涨停异动重复
   - 按当日涨幅降序排列

```python
# 异动板块采集逻辑（在 collect_and_save 中）
LIMIT_UP_ANOMALY_THRESHOLD = 10

# 1. 涨停异动：涨停数>10且不在TOP10
for concept in all_concepts:
    if concept['limit_up_count'] > 10 and concept['concept_name'] not in top_n_names:
        concept['is_anomaly'] = True
        concept['anomaly_type'] = 'limit_up'
        anomaly_concepts.append(concept)

# 2. 涨幅异动：当日涨幅前2且不在TOP10
for concept in change_pct_sorted[:2]:
    if concept['concept_name'] not in top_n_names and not already_added:
        concept['is_anomaly'] = True
        concept['anomaly_type'] = 'change_pct'
        anomaly_concepts.append(concept)
```

**意义**: 发现被主流视野忽略但有潜力的边缘题材

### 7.4 龙头股计算逻辑

#### 7.4.1 龙头股定义

概念板块中最具代表性的涨停股

#### 7.4.2 选择优先级

1. **连板数最高** - 优先选择连续涨停次数最多的
2. **创业板/科创板优先** - 若连板数相同，优先选择300/688开头的股票
3. **涨幅最大** - 若板块相同，选择当日涨幅最大的
4. **封板时间最早** - 若涨幅也相同，选择首次封板时间最早的

```python
# 龙头股排序逻辑
stocks.sort(key=lambda x: (
    -x['continuous_days'],  # 连板数降序
    not x['is_gem'],        # 创业板/科创板优先
    -x['change_pct'],       # 涨幅降序
    x['first_time'],        # 首封时间升序
))
leader = stocks[0]
```

### 7.5 5日涨幅计算

#### 7.5.1 计算方法

使用涨跌幅复利计算:

```python
# 公式: ((1 + r1/100) * (1 + r2/100) * ... * (1 + rn/100) - 1) * 100
cumulative_return = 1.0
for pct in last_5_days_pct_change:
    cumulative_return *= (1 + pct / 100)
change_5d = (cumulative_return - 1) * 100
```

#### 7.5.2 特殊情况

- 数据不足5天：使用实际天数计算
- 单独查询补充：对数据不足的概念单独查询历史数据
- 失败回退：5日涨幅计算失败时使用当日涨幅

### 7.6 数据存储结构

#### 7.6.1 热门概念记录

```python
# is_anomaly = False, rank = 1-10
{
    "trade_date": "2025-12-11",
    "concept_name": "机器人",
    "day_change_pct": 3.25,
    "change_pct": 15.8,  # 5日涨幅
    "limit_up_count": 18,
    "leader_stock_code": "300124",
    "leader_stock_name": "汇川技术",
    "leader_continuous_days": 3,
    "rank": 1,
    "is_anomaly": False,
    "anomaly_type": None
}
```

#### 7.6.2 异动板块记录

```python
# is_anomaly = True
{
    "trade_date": "2025-12-11",
    "concept_name": "华为概念",
    "day_change_pct": 5.12,
    "change_pct": 8.5,
    "limit_up_count": 12,
    "leader_stock_code": "002475",
    "leader_stock_name": "立讯精密",
    "leader_continuous_days": 2,
    "rank": 11,
    "is_anomaly": True,
    "anomaly_type": "limit_up"  # 或 "change_pct"
}
```

### 7.7 API展示逻辑

```python
# 1. 获取热门板块
hot_concepts = query(is_anomaly=False, rank<=10)

# 2. 计算趋势板块
trend_sectors = sort_by(hot_concepts, 'change_pct')[:6]

# 3. 计算情绪板块
emotion_sectors = filter(hot_concepts, limit_up_count > 10)

# 4. 计算主线板块
main_sectors = trend_sectors ∩ emotion_sectors

# 5. 获取异动板块
anomaly_concepts = query(is_anomaly=True)
# 涨停异动在上，涨幅异动在下
anomaly_sectors = sort(limit_up_anomalies) + sort(change_pct_anomalies)
```

### 7.8 相关代码位置

| 逻辑 | 文件路径 |
|------|---------|
| 概念板块采集 | `backend/app/services/collectors/hot_concepts_collector.py` |
| 异动板块计算 | `hot_concepts_collector.py` → `collect_and_save()` |
| 龙头股计算 | `hot_concepts_collector.py` → `_calculate_leader_stock()` |
| 涨停数计算 | `hot_concepts_collector.py` → `_calculate_limit_up_count()` |
| 5日涨幅计算 | `hot_concepts_collector.py` → `_calculate_5day_change_tushare()` |
| API展示 | `backend/app/routers/sector.py` → `get_sector_analysis()` |
| 前端展示 | `frontend/app/sector/page.tsx` |

---

## 8. 大盘指数走势判断

### 8.1 设计目标

通过均线位置和近期涨跌幅，自动生成大盘走势判断和描述文案，帮助交易者快速了解市场整体趋势。

### 8.2 核心指标

| 指标 | 说明 | 计算方式 |
|------|------|---------|
| MA5 | 5日均线 | 近5日收盘价平均值 |
| MA10 | 10日均线 | 近10日收盘价平均值 |
| MA20 | 20日均线 | 近20日收盘价平均值 |
| change_5d | 近5日涨跌幅 | 复利计算：((1+r1)×(1+r2)×...×(1+r5)-1)×100% |
| ma5_position | 价格相对MA5位置 | above（站上）/ below（跌破） |

### 8.3 走势判断规则

#### 8.3.1 上涨趋势

**条件**：
```python
if (close_price > ma5 and
    ma5 > ma10 > ma20 and  # 均线多头排列
    change_5d > 2):        # 近5日涨幅 > 2%
    trend = "上涨"
```

#### 8.3.2 下跌趋势

**条件**：
```python
if (close_price < ma5 and
    ma5 < ma10 < ma20 and  # 均线空头排列
    change_5d < -2):       # 近5日跌幅 > 2%
    trend = "下跌"
```

#### 8.3.3 震荡趋势

**条件**：不满足上涨或下跌条件的其他情况

```python
else:
    trend = "震荡"
```

### 8.4 描述文案生成

走势描述文案是**根据当日数据动态生成**的，不是预设的固定文案。

#### 8.4.1 上涨趋势文案

| 条件 | 文案模板 |
|------|---------|
| 完整数据（≥20天） | `多头排列，价格站上MA5，近5日涨{change_5d}%` |
| 有限数据（<20天） | `价格站上MA5和MA10，近5日涨{change_5d}%（数据有限，仅供参考）` |

#### 8.4.2 下跌趋势文案

| 条件 | 文案模板 |
|------|---------|
| 完整数据（≥20天） | `空头排列，价格跌破MA5，近5日跌{change_5d}%` |
| 有限数据（<20天） | `价格跌破MA5和MA10，近5日跌{change_5d}%（数据有限，仅供参考）` |

#### 8.4.3 震荡趋势文案

根据细分条件生成不同文案：

| 条件 | 文案模板 |
|------|---------|
| \|change_5d\| < 2% | `横盘整理，近5日涨跌幅{change_5d}%，波动较小` |
| 价格 > MA5 且 价格 < MA10 | `短期偏强，价格在MA5和MA10之间震荡` |
| 价格 < MA5 且 价格 > MA10 | `短期偏弱，价格在MA5和MA10之间震荡` |
| ma5_position = "above" | `短期偏强，价格站上MA5，区间震荡` |
| ma5_position = "below" | `短期偏弱，价格跌破MA5，区间震荡` |
| 其他情况 | `区间震荡，均线未形成明确排列` 或 `区间震荡，等待方向选择` |

#### 8.4.4 数据不足文案

| 条件 | 文案模板 |
|------|---------|
| 历史数据 < 7天 | `历史数据仅{N}天，至少需要7天数据` |
| 历史数据 < 20天 | 在正常文案后追加 `（数据有限，仅供参考）` |

### 8.5 完整判断逻辑

```python
def calculate_trend_analysis(kline_data):
    """计算走势分析"""

    # 数据不足判断
    if len(kline_data) < 7:
        return {
            "trend": "数据不足",
            "description": f"历史数据仅{len(kline_data)}天，至少需要7天数据"
        }

    # 获取最新数据
    latest = kline_data[-1]
    close_price = latest['close_price']

    # 计算均线
    ma5 = sum([d['close_price'] for d in kline_data[-5:]]) / 5
    ma10 = sum([d['close_price'] for d in kline_data[-10:]]) / 10 if len(kline_data) >= 10 else None
    ma20 = sum([d['close_price'] for d in kline_data[-20:]]) / 20 if len(kline_data) >= 20 else None

    # 计算近5日涨幅（复利）
    cumulative = 1.0
    for d in kline_data[-5:]:
        cumulative *= (1 + d['change_pct'] / 100)
    change_5d = (cumulative - 1) * 100

    # 判断均线排列
    ma_aligned_up = ma10 and ma20 and (ma5 > ma10 > ma20)
    ma_aligned_down = ma10 and ma20 and (ma5 < ma10 < ma20)

    # 判断价格相对均线位置
    ma5_position = "above" if close_price > ma5 else "below"

    # 综合判断走势
    if ma20:  # 有20天数据，使用完整判断
        if close_price > ma5 and ma_aligned_up and change_5d > 2:
            trend = "上涨"
            description = f"多头排列，价格站上MA5，近5日涨{change_5d:.2f}%"
        elif close_price < ma5 and ma_aligned_down and change_5d < -2:
            trend = "下跌"
            description = f"空头排列，价格跌破MA5，近5日跌{abs(change_5d):.2f}%"
        else:
            trend = "震荡"
            if abs(change_5d) < 2:
                description = f"横盘整理，近5日涨跌幅{change_5d:.2f}%，波动较小"
            elif close_price > ma5 and close_price < ma10:
                description = f"短期偏强，价格在MA5和MA10之间震荡"
            elif close_price < ma5 and close_price > ma10:
                description = f"短期偏弱，价格在MA5和MA10之间震荡"
            else:
                description = f"区间震荡，均线未形成明确排列"
    else:  # 数据不足20天，使用简化判断
        # ... 简化逻辑，文案追加"（数据有限，仅供参考）"

    return {
        "trend": trend,
        "ma5": ma5,
        "ma10": ma10,
        "ma20": ma20,
        "change_5d": change_5d,
        "ma5_position": ma5_position,
        "description": description
    }
```

### 8.6 前端展示

| 走势 | 颜色 | 图标 |
|------|------|------|
| 上涨 | 红色 | ↑ |
| 下跌 | 绿色 | ↓ |
| 震荡 | 黄色 | → |
| 数据不足 | 灰色 | - |

### 8.7 相关代码位置

| 逻辑 | 文件路径 |
|------|---------|
| 走势计算 | `backend/app/routers/market.py` → `calculate_trend_analysis()` |
| 历史K线API | `backend/app/routers/market.py` → `get_index_history()` |
| 前端展示 | `frontend/app/market/page.tsx` |

---

## 9. 高标梯队分析

### 9.1 设计目标

分析4板及以上高标股所属的热门概念板块，展示其完整梯队结构，帮助交易者判断高板能否持续和概念板块的接力强度。

### 9.2 核心逻辑

#### 9.2.1 三层筛选条件

高标梯队需同时满足以下三个条件：

| 条件 | 说明 | 阈值 |
|------|------|------|
| **高标存在** | 概念板块中有4板及以上的龙头股 | continuous_days >= 4 |
| **热门板块** | 概念板块在首页热门前十榜单中 | rank <= 10 且 is_anomaly = false |
| **梯队完整** | 梯队层级数量充足 | 梯队层级 >= 3 |

**逻辑流程**：
```python
# 1. 获取4板+高标股
high_board_stocks = query(continuous_days >= 4)

# 2. 获取热门概念前十
top10_concepts = query(rank <= 10, is_anomaly = false)

# 3. 查询高标股所属概念（使用 ths_concept_members 表）
stock_concepts = query_concepts_from_mapping(high_board_stocks)

# 4. 筛选：只保留在前十榜单中的概念
filtered_concepts = stock_concepts ∩ top10_concepts

# 5. 对每个概念，查询其所有涨停成分股（包括1板）
for concept in filtered_concepts:
    concept_limit_stocks = query_concept_limit_stocks(concept, all_limit_stocks)

    # 6. 构建梯队分布
    ladder = build_ladder_distribution(concept_limit_stocks)

    # 7. 验证梯队层级
    if len(ladder.keys()) >= 3:
        show_concept_ladder(concept)
```

#### 9.2.2 梯队层级定义

**梯队层级** = 概念内不同连板天数的数量

例如某概念有以下涨停股：
- 5板：1只
- 2板：6只
- 1板：14只

则梯队层级 = 3层（5板+2板+1板）

**最低要求**: 梯队层级 >= 3

**意义**: 梯队层级越多，说明概念接力越完整，高低切换空间越大

### 9.3 主线板块标注

#### 9.3.1 主线定义

**主线板块** = TOP10热门板块 ∩ 涨停数>=8

```python
# 从 hot_concepts 表获取主线板块
main_line_concepts = query(
    rank <= 10,
    is_anomaly = false,
    limit_up_count >= 8
)
```

#### 9.3.2 标注逻辑

在高标梯队分析中，如果概念是主线板块，显示红色"主线"标签：

```python
for concept in ladder_concepts:
    if concept.name in main_line_concepts:
        show_badge("主线", color="red")
    else:
        show_nothing()  # 不显示任何标签
```

**展示效果**:
- **商业航天** [主线] - 涨停数21只 >= 8
- **中芯国际概念** - 涨停数6只 < 8（不显示标签）

### 9.4 数据来源

| 数据表/接口 | 用途 | 说明 |
|------------|------|------|
| `limit_stocks_detail` | 获取4板+高标股和所有涨停股 | 主数据源 |
| `hot_concepts` | 获取前十热门概念和主线判断 | rank <= 10, limit_up_count |
| `ths_concept_members` | 完整的概念-成分股映射关系 | 补全概念信息，解决数据不全问题 |

**为什么使用 ths_concept_members 表**：
- `limit_stocks_detail.concepts` 字段数据不全，部分高标股概念缺失
- `ths_concept_members` 表包含71,634+条完整的概念-成分股映射
- 例如：再升科技有15个概念，商业航天概念有338只成分股

### 9.5 梯队展示逻辑

#### 9.5.1 梯队分布

按连板天数降序展示，每层显示：
- **连板天数** (days)
- **股票数量** (count)
- **代表股票** (stocks，最多显示3只)

```json
{
  "concept_name": "商业航天",
  "max_continuous_days": 5,
  "total_limit_up_count": 21,
  "is_main_line": true,
  "ladder": [
    {"days": 5, "count": 1, "stocks": ["再升科技"]},
    {"days": 2, "count": 6, "stocks": ["华菱线缆", "中超控股", "雪人集团"]},
    {"days": 1, "count": 14, "stocks": ["四川九洲", "西部材料", "泰尔股份"]}
  ]
}
```

#### 9.5.2 前端展示样式

- **外框**: 灰色背景 (bg-gray-50)，无边框
- **标签**: 主线板块显示红色"主线"标签
- **梯队卡片**:
  - 5板+：红色背景 (bg-red-100)
  - 4板：橙色背景 (bg-orange-100)
  - 其他：白色背景 (bg-white)

### 9.6 业务意义

| 维度 | 说明 |
|------|------|
| **高标能否持续** | 梯队完整说明接力活跃，高板易晋级 |
| **低吸机会** | 1板、2板是低位接力点，梯队完整时更安全 |
| **主线识别** | 主线板块是市场核心，资金关注度最高 |
| **题材热度** | 前十热门+高标存在=题材正处于活跃期 |

### 9.7 相关代码位置

| 逻辑 | 文件路径 |
|------|---------|
| 梯队分析核心逻辑 | `backend/app/services/sentiment_service.py` → `_get_concept_ladder()` |
| 概念成分股查询 | `backend/app/services/sentiment_service.py` → 使用 `ths_concept_members` 表 |
| Schema定义 | `backend/app/schemas/sentiment.py` → `ConceptLadderItem` |
| API路由 | `backend/app/routers/sentiment.py` → `get_sentiment_analysis()` |
| 前端展示 | `frontend/app/sentiment/page.tsx` → `ConceptLadderCard` |

---

## 10. 龙头股深度分析

### 10.1 设计目标

对4板及以上的龙头股进行四个维度的深度分析，帮助交易者判断龙头股的操作价值和风险。

### 10.2 筛选条件

```python
# 获取4板+龙头股，按连板数降序排列
leaders = query(
    continuous_days >= 4,
    limit_type = "limit_up"
).order_by(continuous_days DESC)
```

### 10.3 四维分析体系

#### 10.3.1 技术面分析

**目的**: 评估封板强度和技术走势

| 指标 | 强势标准 | 中性标准 | 弱势标准 | 颜色 |
|------|---------|---------|---------|------|
| **首封时间** | < 10:00（早盘） | 10:00-13:30 | > 13:30（尾盘） | 红/灰/绿 |
| **开板次数** | 0次（一字板） | 1次 | ≥2次（烂板） | 红/灰/绿 |
| **换手率** | < 20%（筹码稳定） | 20%-35% | > 35%（获利盘多） | 红/灰/绿 |

**评级逻辑**:
```python
# 首封时间
if first_time < "10:00:00":
    level = "strong"  # 早盘强势
elif first_time < "13:30:00":
    level = "normal"
else:
    level = "weak"    # 尾盘弱势

# 开板次数
if opening_times == 0:
    level = "strong"  # 一字板
elif opening_times <= 1:
    level = "normal"
else:
    level = "weak"    # 烂板

# 换手率
if turnover_rate < 20:
    level = "strong"  # 筹码稳定
elif turnover_rate < 35:
    level = "normal"
else:
    level = "weak"    # 获利盘多
```

#### 10.3.2 资金面分析

**目的**: 评估主力资金承接力度

| 指标 | 强势标准 | 中性标准 | 弱势标准 |
|------|---------|---------|---------|
| **主力净流入** | > 0 且占比 > 10% | > 0 | ≤ 0（资金流出） |
| **封单比** | > 50%（封单强） | 20%-50% | < 20%（易炸板） |

**计算公式**:
```python
# 主力净流入评级
if main_inflow > 0 and main_inflow_pct > 10:
    level = "strong"  # 主力大幅流入
elif main_inflow > 0:
    level = "normal"  # 小幅流入
else:
    level = "weak"    # 资金流出

# 封单比
sealed_ratio = (sealed_amount / amount) * 100

if sealed_ratio > 50:
    level = "strong"  # 封单强
elif sealed_ratio > 20:
    level = "normal"
else:
    level = "weak"    # 易炸板
```

#### 10.3.3 梯队情况分析

**目的**: 评估概念板块接力强度

**逻辑流程**:
1. 从 `ths_concept_members` 表查询该股票的所有概念
2. 取第一个概念作为主概念
3. 查询当日所有涨停股中，同属于该主概念的其他股票
4. 统计跟风股数量和梯队分布

**梯队状态**:
```python
if follower_count >= 3:
    status = "complete"  # 梯队完整
elif follower_count >= 1:
    status = "normal"    # 一般
else:
    status = "alone"     # 独苗
```

#### 10.3.4 综合评估

**目的**: 基于前三维度，自动生成利好/风险因素并给出操作建议

**利好因素** (+绿色):
- 早盘封板，强势
- 未开板，封单稳固
- 主力净流入X亿
- 封单强，封单比X%
- 板块梯队完整，有跟风

**风险因素** (-红色):
- 尾盘封板，弱势
- 开板X次，烂板
- 换手率X%，获利盘多
- 主力资金流出
- 封单弱，易炸板
- 独苗，无跟风
- X连板高位，溢价空间有限（≥5板）

**综合结论**:
```python
if len(positive) > len(negative):
    conclusion = "机会 > 风险"  # 红色背景
elif len(positive) < len(negative):
    conclusion = "风险 > 机会"  # 绿色背景
else:
    conclusion = "机会与风险并存"  # 灰色背景
```

### 10.4 数据来源

| 数据字段 | 来源表 | 说明 |
|---------|--------|------|
| 首封时间、开板次数、换手率 | `limit_stocks_detail` | AKShare涨停池接口 |
| 主力净流入、成交额 | `limit_stocks_detail` | Tushare资金流向接口 |
| 封单金额 | `limit_stocks_detail` | AKShare涨停池接口 |
| 概念归属 | `ths_concept_members` | 同花顺概念成分股映射表 |

### 10.5 展示逻辑

- **外框**: 灰色背景 (bg-gray-50)，无边框
- **股票信息**: 股票名称 + 连板数标签（红色） + 高标标签（黄色）
- **四维卡片**: 灰色背景，字段值根据评级显示颜色（强势红、中性灰、弱势绿）
- **综合评估**:
  - 机会>风险：红色背景
  - 风险>机会：绿色背景
  - 机会与风险并存：灰色背景

### 10.6 相关代码位置

| 逻辑 | 文件路径 |
|------|---------|
| 龙头分析核心逻辑 | `backend/app/services/sentiment_service.py` → `_get_leader_analysis()` |
| 技术面分析 | `backend/app/services/sentiment_service.py` → `_analyze_technical()` |
| 资金面分析 | `backend/app/services/sentiment_service.py` → `_analyze_capital()` |
| 梯队分析 | `backend/app/services/sentiment_service.py` → `_get_stock_ladder()` |
| 综合评估 | `backend/app/services/sentiment_service.py` → `_evaluate_leader()` |
| Schema定义 | `backend/app/schemas/sentiment.py` → `LeaderAnalysisItem` |
| 前端展示 | `frontend/app/sentiment/page.tsx` → `LeaderAnalysisCard` |

---

## 更新日志

| 日期 | 版本 | 更新内容 |
|------|------|---------|
| 2025-12-10 | v1.0 | 初始版本，包含市场情绪评分、涨跌停判断、炸板率、连板分布、主力资金流向逻辑说明 |
| 2025-12-12 | v2.0 | 新增情绪周期阶段判断逻辑（多因子梯度打分算法），包含数据来源、指标定义、打分规则、阶段映射、退潮判断等完整说明 |
| 2025-12-12 | v2.1 | 新增板块分析四大模块逻辑（趋势板块、情绪板块、主线板块、异动板块），包含筛选规则、龙头股计算、5日涨幅计算等 |
| 2025-12-13 | v2.2 | **优化市场情绪评分逻辑**：涨停数和跌停数从"环比变化"改为"绝对数量"评分，参考A股市场通用标准（涨停≥100→+1，50-99→0，<50→-1；跌停≤5→+1，6-15→0，>15→-1），更客观反映市场真实情绪 |
| 2025-12-13 | v2.3 | **新增大盘指数走势判断逻辑**：包含均线计算（MA5/MA10/MA20）、走势判断规则（上涨/下跌/震荡）、描述文案动态生成规则，文案根据当日数据实时计算生成 |
| 2025-12-13 | v2.4 | **调整趋势板块筛选规则**：从"5日涨幅前6"改为"热门板块TOP10全部"，只要在首页热门概念板块中即为趋势板块，主线板块判断更宽松 |
| 2025-12-13 | v2.5 | **情绪周期阶段v2.2升级**：(1)新增跌停数因子(2)涨停数阈值优化为<10/-2,10-29/-1,30-69/0,70-89/+1,≥90/+2(3)跌停数=0得分改为+1避免高估(4)炸板率中间区间35-50%(5)晋级率细化<15%/-2,15-25%/-1(6)阶段阈值调整为±6(7)退潮期空间板条件从≥3改为≥4 |
| 2025-12-13 | v2.6 | **新增惯性区间机制(v2.3)**：边界±1范围内沿用昨日阶段，减少边界抖动；明显跨越边界时立即切换，保持快速响应。适合超短线玩家：大趋势能跟上，边缘抖动被压住 |
| 2025-12-13 | v2.7 | **新增高标梯队分析和龙头股深度分析逻辑**：(1)高标梯队分析：4板+股票所属热门概念前十的梯队结构，主线板块标注，使用ths_concept_members表补全概念信息(2)龙头股深度分析：四维分析体系（技术面、资金面、梯队、综合评估），自动生成利好/风险因素 |
| 2025-12-13 | v2.8 | **新增个股明日溢价概率评分模型文档**：(1)五维评分体系（技术面、资金面、题材地位、位置风险、市场环境）(2)详细阈值配置和计算公式(3)溢价等级映射规则(4)12月11日回测结果摘要(5)使用建议和优化方向 |

## 11. 个股明日溢价概率评分模型（v2.0）

### 11.1 设计目标

对涨停股进行多维度评分，预测其次日获得溢价的概率，帮助交易者识别高质量打板机会和规避高风险标的。

**适用场景**:
- 龙头股深度分析
- 自选股溢价评估
- 涨停股筛选评分

### 11.2 评分模型概述

#### 11.2.1 五维评分体系

| 维度 | 权重 | 分值范围 | 说明 |
|------|------|---------|------|
| 技术面 | 1.0 | -2 ~ +2 | 封板强度和走势 |
| 资金面 | 1.0 | -2 ~ +2 | 主力资金承接力 |
| 题材地位 | 1.0 | -2 ~ +2 | 概念热度和梯队 |
| 位置风险 | 1.0 | -2 ~ +2 | 连板数高低 |
| 市场环境 | 0.5 | -1 ~ +1 | 情绪周期阶段 |

**总分计算**:
```
总分 = 技术面 + 资金面 + 题材地位 + 位置风险 + 市场环境 × 0.5
理论范围: -9 ~ +9
```

#### 11.2.2 溢价等级映射

| 总分范围 | 溢价等级 | 颜色 | 溢价预期 |
|---------|---------|------|---------|
| ≥ 6 | 极高 | 红色 | 次日大概率高开或涨停 |
| 4 ~ 5 | 高 | 橙色 | 次日大概率正溢价 |
| 2 ~ 3 | 偏高 | 黄色 | 次日可能正溢价 |
| 0 ~ 1 | 中性 | 灰色 | 次日涨跌不确定 |
| -2 ~ -1 | 偏低 | 蓝色 | 次日可能负溢价 |
| < -2 | 低 | 紫色 | 次日大概率低开或大跌 |

### 11.3 维度一：技术面评分（-2 ~ +2）

#### 11.3.1 评分因子

**因子1: 封板时间** (time_score)

| 封板时间 | 得分 | 说明 |
|---------|------|------|
| 集合竞价/一字板 | +2.0 | 开盘即封，强势 |
| < 10:00 | +1.5 | 早盘封板，偏强 |
| 10:00 ~ 13:00 | +1.0 | 午盘封板，正常 |
| 13:00 ~ 14:00 | 0.0 | 下午封板，一般 |
| > 14:00 | -1.0 | 尾盘封板，弱势 |

**因子2: 开板次数惩罚**

| 开板次数 | 惩罚 | 说明 |
|---------|------|------|
| 0次 | 不调整 | 一字板，封单稳固 |
| 1次 | -0.5 | 开过一次，略显分歧 |
| ≥2次 | -1.0 | 烂板，分歧大 |

**因子3: 换手率** (turnover_score)

| 换手率 | 得分 | 说明 |
|--------|------|------|
| < 5% | -1.0 | 换手过低，筹码僵化 |
| 5% ~ 10% | 0.0 | 换手偏低 |
| 10% ~ 15% | +1.0 | 充分换手 |
| 15% ~ 20% | +2.0 | 最佳换手区间 |
| 20% ~ 25% | +1.0 | 换手偏高 |
| ≥ 25% | +1.0 | 换手过高，获利盘多 |

#### 11.3.2 计算公式

```python
技术面得分 = (time_score + turnover_score) / 2
技术面得分 = max(-2, min(2, 技术面得分))  # 截断到[-2, +2]

# 一字板特判
if is_strong_limit and opening_times == 0:
    技术面得分 = max(技术面得分, 1.0)  # 至少+1分
```

#### 11.3.3 阈值配置

```python
"first_limit_early": 0,          # 集合竞价封板（分钟数）
"first_limit_good": 30,          # 10:00前封板
"first_limit_medium": 210,       # 13:00前封板
"first_limit_late": 270,         # 14:00前封板
"turnover_low": 5,               # 低换手
"turnover_medium_low": 10,       # 中低换手
"turnover_medium_high": 15,      # 中高换手
"turnover_high": 20,             # 高换手
"turnover_very_high": 25,        # 极高换手
```

### 11.4 维度二：资金面评分（-2 ~ +2）

#### 11.4.1 评分因子

**因子1: 封单比** (sealed_score)

```
封单比 = 封单金额 / 成交额
```

| 封单比 | 得分 | 说明 |
|--------|------|------|
| ≥ 10 | +2.0 | 封单极强，资金坚决 |
| 3 ~ 10 | +1.0 | 封单较强 |
| 0.5 ~ 3 | 0.0 | 封单一般 |
| < 0.5 | -2.0 | 封单很弱，易炸板 |

**因子2: 主力净流入占比** (inflow_score)

```
主力净流入占比 = 主力净流入 / 成交额 × 100%
```

| 净流入占比 | 得分 | 说明 |
|-----------|------|------|
| > +10% | +2.0 | 主力大幅流入 |
| +5% ~ +10% | +1.0 | 主力中度流入 |
| 0 ~ +5% | 0.0 | 主力小幅流入 |
| -10% ~ 0 | -1.0 | 主力流出 |
| < -10% | -2.0 | 主力大幅流出 |

#### 11.4.2 计算公式

```python
资金面得分 = (sealed_score + inflow_score) / 2
资金面得分 = max(-2, min(2, 资金面得分))
```

#### 11.4.3 阈值配置

```python
"sealed_ratio_strong": 10,       # 强封单比
"sealed_ratio_medium": 3,        # 中等封单比
"sealed_ratio_weak": 0.5,        # 弱封单比
"inflow_pct_heavy_out": -10,     # 明显砸盘
"inflow_pct_light_in": 5,        # 小幅流入
"inflow_pct_medium_in": 10,      # 中等流入
```

### 11.5 维度三：题材地位评分（-2 ~ +2）

#### 11.5.1 评分因子

**因子1: 题材热度** (theme_hot_score)

| 条件 | 得分 | 说明 |
|------|------|------|
| 在TOP10热门 且 涨停数≥8（主线） | +2.0 | 主线题材，资金关注度极高 |
| 在TOP10热门（非主线） | +1.0 | 热门题材 |
| 不在TOP10 | 0.0 | 普通题材 |

**因子2: 梯队状态** (ladder_score)

| 梯队状态 | 得分 | 说明 |
|---------|------|------|
| 完整梯队（≥3层） | +2.0 | 接力活跃，高低切换顺畅 |
| 正常梯队（2层） | 0.0 | 有一定跟风 |
| 独苗（1层） | -2.0 | 无跟风，情绪差 |

**梯队层级定义**:
- 统计概念内不同连板天数的数量
- 例如: 5板1只+2板6只+1板14只 = 3层梯队

#### 11.5.2 计算公式

```python
题材地位得分 = (theme_hot_score + ladder_score) / 2
题材地位得分 = max(-2, min(2, 题材地位得分))
```

#### 11.5.3 数据来源

| 数据 | 来源表 | 说明 |
|------|--------|------|
| 股票所属概念 | `ths_concept_members` | 完整的概念-成分股映射 |
| TOP10热门概念 | `hot_concepts` | rank <= 10, is_anomaly = false |
| 涨停数判断主线 | `hot_concepts` | limit_up_count >= 8 |
| 梯队统计 | `limit_stocks_detail` | 查询概念成分股的连板分布 |

### 11.6 维度四：位置风险评分（-2 ~ +2）

#### 11.6.1 评分规则

**原则**: 连板数越高，风险越大，得分越低

| 连板数 | 得分 | 风险等级 | 说明 |
|--------|------|---------|------|
| 1板（首板） | +2.0 | 极低 | 最安全，溢价空间大 |
| 2板 | +1.0 | 低 | 较安全 |
| 3-4板 | 0.0 | 中 | 高低切换关键位 |
| 5-6板 | -1.0 | 高 | 高位，溢价空间收窄 |
| ≥7板 | -2.0 | 极高 | 极高位，随时可能见顶 |

#### 11.6.2 阈值配置

```python
"position_very_high": 7,         # 极高位（7板以上）
"position_high": 5,              # 高位（5-6板）
"position_medium": 3,            # 中位（3-4板）
```

### 11.7 维度五：市场环境评分（-1 ~ +1）

#### 11.7.1 情绪阶段映射

**数据来源**: 从情绪周期阶段判断模块获取当日所处阶段

| 情绪阶段 | 得分 | 权重后得分 | 说明 |
|---------|------|-----------|------|
| 高潮期 | +2 | +1.0 | 市场情绪极度亢奋，溢价概率高 |
| 加速期 | +1 | +0.5 | 市场情绪升温，溢价概率较高 |
| 回暖期 | -1 | -0.5 | 市场开始回暖，溢价概率偏低 |
| 冰点期 | -2 | -1.0 | 市场极度低迷，溢价概率很低 |
| 退潮期 | -2 | -1.0 | 高位见顶回落，溢价概率很低 |

#### 11.7.2 计算公式

```python
市场环境得分 = emotion_stage_map[情绪阶段] × 0.5
```

#### 11.7.3 阈值配置

```python
"emotion_stage_map": {
    "冰点期": -2,
    "回暖期": -1,
    "退潮期": -2,
    "加速期": +1,
    "高潮期": +2
}
```

### 11.8 总分计算与溢价等级映射

#### 11.8.1 总分计算

```python
总分 = 技术面得分 + 资金面得分 + 题材地位得分 + 位置风险得分 + 市场环境得分
总分 = round(总分, 2)
```

**理论范围**: -9 ~ +9
- 最低分: -2 -2 -2 -2 -1 = -9
- 最高分: +2 +2 +2 +2 +1 = +9

#### 11.8.2 溢价等级映射

```python
if total_score >= 6:
    premium_level = "极高"
    color = "red"
elif total_score >= 4:
    premium_level = "高"
    color = "orange"
elif total_score >= 2:
    premium_level = "偏高"
    color = "yellow"
elif total_score >= 0:
    premium_level = "中性"
    color = "gray"
elif total_score >= -2:
    premium_level = "偏低"
    color = "blue"
else:
    premium_level = "低"
    color = "purple"
```

### 11.9 回测结果摘要（2025-12-11数据）

#### 11.9.1 整体表现

| 指标 | 数值 |
|------|------|
| 回测样本数 | 32只涨停股 |
| 正溢价率 | 65.6% (21/32) |
| 平均溢价 | +3.15% |
| 最大溢价 | +19.98% (通光线缆) |
| 最大亏损 | -10.03% (南都物业) |

#### 11.9.2 各档位表现

| 档位 | 样本数 | 次日平均涨幅 | 正溢价率 | 大面率 |
|------|--------|-------------|---------|--------|
| 极高 (≥6分) | 3只 | +9.98% | 100% | 0% |
| 高 (4-5分) | 10只 | +3.57% | 70% | 10% |
| 偏高 (2-3分) | 10只 | +0.88% | 60% | 10% |
| 中性 (0-1分) | 8只 | +2.39% | 62.5% | 12.5% |
| 偏低 (负分) | 1只 | -10.03% | 0% | 100% |

#### 11.9.3 关键发现

**优势**:
1. **极高档位准确率100%**: 3只股票全部次日大幅溢价（均≥+9.9%）
2. **偏低档位准确率100%**: 1只负分股票次日跌停(-10.03%)
3. **6分以上极高可靠**: 总分≥6的股票，溢价预期极强

**待优化**:
1. **5分档位不稳定**: 仅40%正溢价率，需进一步细化阈值
2. **中性档位表现超预期**: 0-1分档位反而有62.5%正溢价，可能需要增加"观察"等级
3. **样本量较小**: 仅32只样本，需扩大回测周期验证

### 11.10 使用建议

#### 11.10.1 操作参考

| 总分 | 操作建议 |
|------|---------|
| ≥ 6分 | 可重点关注，大概率溢价 |
| 4-5分 | 可适度参与，溢价概率较高 |
| 2-3分 | 谨慎参与，结合其他因素判断 |
| 0-1分 | 观望为主，不确定性大 |
| < 0分 | 回避为主，大概率亏损 |

#### 11.10.2 特殊情况

1. **一字板股票**: 技术面至少+1分，封板强度有保障
2. **主线题材龙头**: 题材地位+2分，溢价概率大幅提升
3. **高位板（≥7板）**: 位置风险-2分，即使其他维度强，总分也会被拉低
4. **市场冰点/退潮期**: 市场环境-1分，整体降低溢价预期

### 11.11 相关代码位置

| 逻辑 | 文件路径 |
|------|---------|
| 评分服务主逻辑 | `backend/app/services/premium_probability_service.py` |
| 技术面计算 | `premium_probability_service.py` → `_calculate_technical_score()` |
| 资金面计算 | `premium_probability_service.py` → `_calculate_capital_score()` |
| 题材地位计算 | `premium_probability_service.py` → `_calculate_theme_score()` |
| 位置风险计算 | `premium_probability_service.py` → `_calculate_position_score()` |
| 市场环境计算 | `premium_probability_service.py` → `_calculate_market_score()` |
| 溢价等级映射 | `premium_probability_service.py` → `_map_premium_level()` |
| 阈值配置 | `premium_probability_service.py` → `self.config` |
| 回测脚本 | `backend/backtest_premium_score.py` |
| Schema定义 | `backend/app/schemas/premium.py` |

### 11.12 后续优化方向

1. **扩大回测样本**: 使用1-3个月历史数据验证模型稳定性
2. **细化5分档位**: 5分档位表现不稳定，考虑调整阈值或增加观察等级
3. **阈值动态化**: 根据市场环境动态调整各维度阈值
4. **增加观察等级**: 在"中性"和"偏高"之间增加"观察"等级
5. **因子权重优化**: 根据回测结果调整各维度权重
6. **北交所股票适配**: 针对北交所股票特性调整评分规则

---

## 附录：相关代码位置

| 逻辑 | 文件路径 |
|------|---------|
| 市场情绪评分 | `frontend/app/page.tsx` |
| 炸板率计算 | `backend/app/services/collectors/limit_stocks_collector.py` |
| 主力资金采集 | `backend/app/services/collectors/limit_stocks_collector.py` |
| 连板分布统计 | `backend/app/services/collectors/limit_stocks_collector.py` |
