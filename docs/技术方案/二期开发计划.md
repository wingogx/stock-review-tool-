# A股短线复盘工具 - 二期开发计划

**版本**: v2.0
**日期**: 2025-12-10
**预计工期**: 2周（14个工作日）
**状态**: 待启动

---

## 一、项目概览

### 1.1 开发目标

完成3个核心分析页面，实现完整的交易决策链路：
1. **大盘分析页** - 判断市场环境，决定是否出手
2. **情绪分析页** - 识别连板股机会与风险
3. **趋势分析页** - 追踪主线方向，发现趋势股

### 1.2 核心技术

- **AI集成**：豆包通用模型 pro (1.6) 生成市场分析
- **数据可视化**：Recharts K线图、饼图、柱状图
- **后端扩展**：新增8个API端点
- **数据增强**：20日历史K线数据、连板分布统计

---

## 二、任务分解（WBS）

### Phase 1: 基础设施搭建（2天）

#### Task 1.1: 后端环境配置
**负责人**: 开发者
**工时**: 0.5天

**子任务**:
- [x] 安装豆包SDK：`pip install volcengine-python-sdk`
- [x] 配置环境变量（.env）
  - `DOUBAO_API_KEY`（由用户提供）
  - `DOUBAO_MODEL_ID`
- [x] 测试豆包API连通性
- [x] 安装Redis（可选，用于缓存）

**验收标准**:
- 豆包API测试调用成功
- 环境变量加载正常

---

#### Task 1.2: 数据库Schema调整
**负责人**: 开发者
**工时**: 0.5天

**子任务**:
- [ ] 修改`market_stats`表（新增4个字段）
  ```sql
  ALTER TABLE market_stats ADD COLUMN flat_count INTEGER DEFAULT 0;
  ALTER TABLE market_stats ADD COLUMN up_5pct_count INTEGER DEFAULT 0;
  ALTER TABLE market_stats ADD COLUMN down_5pct_count INTEGER DEFAULT 0;
  ALTER TABLE market_stats ADD COLUMN ladder_distribution JSONB;
  ```
- [ ] 创建`ai_analysis`表（可选，用于缓存AI结果）
- [ ] 添加索引优化
  ```sql
  CREATE INDEX idx_market_index_code_date ON market_index(index_code, trade_date DESC);
  CREATE INDEX idx_hot_concepts_date_strength ON hot_concepts(trade_date, concept_strength DESC);
  ```
- [ ] 测试Supabase连接

**验收标准**:
- Schema修改成功
- 索引创建成功
- 旧数据兼容性正常

---

#### Task 1.3: 采集历史指数数据
**负责人**: 开发者
**工时**: 1天

**子任务**:
- [ ] 开发`HistoricalDataCollector`类
- [ ] 采集三大指数近30日K线数据
- [ ] 保存到`market_index`表
- [ ] 验证数据完整性（20个交易日数据）

**实现**:
```python
# backend/app/services/collectors/historical_data_collector.py

class HistoricalDataCollector:
    async def collect_index_history(self, days: int = 30):
        for symbol in ["sh000001", "sz399001", "sz399006"]:
            df = self.index_collector.collect_index_daily(
                symbol=symbol,
                start_date=start_date,
                end_date=end_date
            )
            count = self.index_collector.save_to_database(symbol, df)
            logger.info(f"采集 {symbol} {count}条历史数据")
```

**验收标准**:
- 三大指数各有≥20条历史数据
- 数据字段完整（开高低收、成交量、涨跌幅）

---

### Phase 2: 大盘分析页面（5天）⭐核心

#### Task 2.1: 后端API - K线数据
**负责人**: 开发者
**工时**: 0.5天

**子任务**:
- [ ] 新增端点：`GET /api/market/index/kline`
- [ ] 参数：`days=20`（默认），`index_codes`（可选）
- [ ] 查询`market_index`表，返回近20日数据
- [ ] 倒序排列（从旧到新）
- [ ] 单元测试

**验收标准**:
- API返回格式正确
- 三大指数各返回20条数据
- 响应时间 < 500ms

---

#### Task 2.2: 后端API - 增强统计
**负责人**: 开发者
**工时**: 1天

**子任务**:
- [ ] 新增端点：`GET /api/market/stats/enhanced`
- [ ] 计算连板分布（查询`limit_stocks`表）
- [ ] 计算平盘数、涨幅>5%、跌幅>5%（算法优化）
- [ ] 返回完整统计数据
- [ ] 单元测试

**实现难点**:
- 连板分布计算：按`continuous_days`分组统计
- 平盘数计算：可能需要从原始行情数据计算（或估算）

**验收标准**:
- `ladder_distribution`字段准确
- 响应时间 < 1秒

---

#### Task 2.3: 后端AI服务 - 豆包集成
**负责人**: 开发者
**工时**: 1.5天

**子任务**:
- [ ] 创建`AIAnalysisService`类
- [ ] 实现`generate_market_analysis()`方法
- [ ] 设计Prompt模板（关键！）
- [ ] 解析AI返回的JSON
- [ ] 实现降级方案（规则引擎）
- [ ] 限流机制（防止滥用）
- [ ] 单元测试（Mock豆包API）

**Prompt设计要点**:
```python
prompt = f"""
请根据以下市场数据分析：
【市场情绪】情绪评分{score}分，涨跌比{ratio}...
【大盘指数】上证{change1}%，深证{change2}%...
【连板梯队】{ladder_str}...
【热门板块】{concepts_str}...

按JSON格式输出：
{{
  "operability_score": 3.5,  # 1-5分
  "conclusion": "观望为主",
  "favorable_factors": ["...", "...", "..."],  # 3条
  "unfavorable_factors": ["...", "...", "..."],  # 3条
  "operation_advice": {{
    "position": "≤30%",
    "direction": "...",
    "risk_warning": "...",
    "strategy": "..."
  }}
}}
"""
```

**验收标准**:
- 豆包API调用成功率 > 95%
- 返回JSON格式统一
- 降级方案生效（模拟API失败）
- 响应时间 < 3秒

---

#### Task 2.4: 后端API - AI市场分析
**负责人**: 开发者
**工时**: 0.5天

**子任务**:
- [ ] 新增端点：`POST /api/ai/market-analysis`
- [ ] 收集市场数据（情绪、涨跌比、热门概念等）
- [ ] 调用`AIAnalysisService`
- [ ] 返回分析结果
- [ ] 缓存结果到`ai_analysis`表（可选）
- [ ] API文档

**验收标准**:
- API返回完整分析结果
- 包含可操作性评分、有利/不利因素、操作建议

---

#### Task 2.5: 前端K线图组件
**负责人**: 开发者
**工时**: 1天

**子任务**:
- [ ] 创建`KLineChart.tsx`组件
- [ ] 使用Recharts绘制K线图
- [ ] 计算MA5/MA10/MA20均线
- [ ] 添加成交量柱状图
- [ ] 自定义Tooltip（hover显示详情）
- [ ] 趋势判断标签（短期强势/中期转弱/支撑位）
- [ ] 响应式设计

**技术要点**:
```tsx
<ComposedChart data={dataWithMA}>
  <Line dataKey="ma5" stroke="#ef4444" />
  <Line dataKey="ma10" stroke="#f59e0b" />
  <Line dataKey="ma20" stroke="#3b82f6" />
  <Line dataKey="close" stroke="#10b981" strokeWidth={2} />
  <Bar dataKey="volume" fill="#e5e7eb" opacity={0.3} />
</ComposedChart>
```

**验收标准**:
- K线图渲染正常
- 均线计算准确
- Tooltip交互流畅
- 移动端适配

---

#### Task 2.6: 前端大盘分析页面
**负责人**: 开发者
**工时**: 1.5天

**子任务**:
- [ ] 创建`/market-analysis/page.tsx`
- [ ] 模块1：AI市场分析展示区
  - 可操作性评分（星级显示）
  - 有利/不利因素列表
  - 操作建议卡片
  - 数据速览表格
- [ ] 模块2：指数走势（3个K线图并排）
- [ ] 模块3：股票整体走势
  - 涨跌分布饼图（Recharts PieChart）
  - 市场宽度指标卡片
  - 连板梯队柱状图
- [ ] 模块4：热门板块TOP10
  - 概念卡片网格（复用已有概念数据）
  - 星级显示
  - 点击弹出详情弹窗
- [ ] 导航栏更新（添加"大盘分析"链接）
- [ ] 加载状态、错误处理
- [ ] 响应式布局

**验收标准**:
- 4个模块完整显示
- AI分析内容格式正确
- K线图正常渲染
- 概念卡片可点击

---

### Phase 3: 情绪分析页面（3天）

#### Task 3.1: 后端API - 连板股分组
**负责人**: 开发者
**工时**: 0.5天

**子任务**:
- [ ] 新增端点：`GET /api/limit/stocks/grouped`
- [ ] 按`continuous_days`分组返回涨停股
- [ ] 每组按封板时间排序
- [ ] 返回格式：
  ```json
  {
    "6": [stock1, stock2],
    "5": [stock3, stock4, ...],
    ...
  }
  ```

**验收标准**:
- 分组正确
- 排序准确

---

#### Task 3.2: 后端AI服务 - 个股分析
**负责人**: 开发者
**工时**: 1天

**子任务**:
- [ ] 新增方法：`generate_stock_analysis()`
- [ ] 设计个股分析Prompt
- [ ] 输入：股票基本面+技术面数据
- [ ] 输出：风险评估+明日策略
- [ ] 单元测试

**Prompt要点**:
```python
f"""
分析股票：{stock_name}({stock_code})
【基本面】{continuous_days}连板，所属{concept}
【技术面】封板时间{seal_time}，封单{seal_orders}万手，换手率{turnover}%
【板块】板块内{limit_up_count}只涨停

请评估：
1. 风险等级（高/中/低）
2. 明日策略（建议参与/谨慎观望/回避）
3. 风险点（2-4条）
4. 机会点（1-2条）

JSON格式输出...
"""
```

**验收标准**:
- 风险评级合理
- 策略建议明确

---

#### Task 3.3: 后端AI服务 - 连板梯队健康度
**负责人**: 开发者
**工时**: 0.5天

**子任务**:
- [ ] 新增方法：`generate_ladder_health()`
- [ ] 输入：连板分布数据
- [ ] 输出：健康度评分+机会/风险股
- [ ] Prompt设计

**验收标准**:
- 健康度评分1-5星
- 机会股/风险股推荐合理

---

#### Task 3.4: 前端情绪分析页面
**负责人**: 开发者
**工时**: 1天

**子任务**:
- [ ] 创建`/sentiment/page.tsx`
- [ ] 连板梯队健康度展示（顶部）
- [ ] 连板股列表（按连板数分组）
- [ ] 股票卡片组件（显示封板时间、封单量等）
- [ ] 点击展开AI分析面板
- [ ] 风险等级标识（🚨🚨🚨）
- [ ] 导航栏更新

**验收标准**:
- 分组展示正常
- AI分析可展开
- 风险评级清晰

---

### Phase 4: 趋势分析页面（3天）

#### Task 4.1: 后端算法 - 主线识别
**负责人**: 开发者
**工时**: 1天

**子任务**:
- [ ] 新增端点：`GET /api/trend/mainline`
- [ ] 算法逻辑：
  - 统计近7日各概念涨停数总和
  - 筛选：累计涨停≥15、连续上涨≥3天、有龙头
  - 判断趋势阶段（萌芽/启动/加速/衰退）
- [ ] 返回1-2个主线
- [ ] 单元测试

**验收标准**:
- 主线识别准确
- 趋势阶段判断合理

---

#### Task 4.2: 后端API - 趋势股票池
**负责人**: 开发者
**工时**: 0.5天

**子任务**:
- [ ] 新增端点：`GET /api/trend/stocks?concept={name}`
- [ ] 返回：龙头股+跟风股+潜伏股
- [ ] 分类规则：
  - 龙头：连板数最高
  - 跟风：已涨停
  - 潜伏：未涨停但异动（涨幅>3%）

**验收标准**:
- 分类准确
- 数据完整

---

#### Task 4.3: 后端AI服务 - 趋势预判
**负责人**: 开发者
**工时**: 0.5天

**子任务**:
- [ ] 新增方法：`generate_trend_forecast()`
- [ ] 输入：主线7日历史数据
- [ ] 输出：延续性预判+操作建议
- [ ] Prompt设计

**验收标准**:
- 预判有依据
- 操作建议明确

---

#### Task 4.4: 前端趋势分析页面
**负责人**: 开发者
**工时**: 1天

**子任务**:
- [ ] 创建`/trend/page.tsx`
- [ ] 主线识别展示（卡片）
- [ ] 主线走势图（7日涨停数折线图）
- [ ] 趋势股票池展示（龙头/跟风/潜伏）
- [ ] AI趋势预判展示
- [ ] 导航栏更新

**验收标准**:
- 主线显示清晰
- 走势图准确
- 股票池分类正确

---

### Phase 5: 测试与优化（1天）

#### Task 5.1: 集成测试
**负责人**: 开发者
**工时**: 0.5天

**子任务**:
- [ ] 端到端测试：大盘分析完整流程
- [ ] 端到端测试：情绪分析完整流程
- [ ] 端到端测试：趋势分析完整流程
- [ ] 跨浏览器测试（Chrome/Safari/Edge）
- [ ] 移动端测试（iPad/iPhone）

**验收标准**:
- 3个页面无阻塞性bug
- 主流程可走通

---

#### Task 5.2: 性能优化
**负责人**: 开发者
**工时**: 0.5天

**子任务**:
- [ ] 压力测试（Locust模拟100并发）
- [ ] 慢查询优化
- [ ] 前端代码分割（动态导入）
- [ ] 图片/资源压缩
- [ ] Redis缓存启用（K线数据、AI分析结果）

**性能目标**:
- 首屏加载 < 2秒
- API响应 < 1秒（K线/统计）
- AI分析 < 3秒

---

#### Task 5.3: 文档与部署
**负责人**: 开发者
**工时**: 0.5天

**子任务**:
- [ ] 更新API文档（新增8个端点）
- [ ] 更新README（新功能说明）
- [ ] 部署到生产环境
  - 后端：更新依赖、运行迁移、重启服务
  - 前端：构建、部署到Vercel
- [ ] 生产环境验证
- [ ] 创建Git tag：`v2.0`

**验收标准**:
- 生产环境正常访问
- 豆包API正常调用
- 无明显bug

---

## 三、任务分配与时间排期

| Phase | 任务 | 工时 | 开始日期 | 结束日期 | 状态 |
|-------|------|------|---------|---------|------|
| **Phase 1** | **基础设施** | **2天** | | | |
| 1.1 | 后端环境配置 | 0.5天 | D1上午 | D1下午 | ⏳待开始 |
| 1.2 | 数据库Schema调整 | 0.5天 | D1下午 | D2上午 | ⏳待开始 |
| 1.3 | 采集历史指数数据 | 1天 | D2上午 | D2下午 | ⏳待开始 |
| **Phase 2** | **大盘分析页面** | **5天** | | | |
| 2.1 | 后端API - K线数据 | 0.5天 | D3上午 | D3下午 | ⏳待开始 |
| 2.2 | 后端API - 增强统计 | 1天 | D3下午 | D4下午 | ⏳待开始 |
| 2.3 | 后端AI服务 - 豆包集成 | 1.5天 | D4下午 | D6上午 | ⏳待开始 |
| 2.4 | 后端API - AI市场分析 | 0.5天 | D6上午 | D6下午 | ⏳待开始 |
| 2.5 | 前端K线图组件 | 1天 | D6下午 | D7下午 | ⏳待开始 |
| 2.6 | 前端大盘分析页面 | 1.5天 | D7下午 | D8下午 | ⏳待开始 |
| **Phase 3** | **情绪分析页面** | **3天** | | | |
| 3.1 | 后端API - 连板股分组 | 0.5天 | D9上午 | D9下午 | ⏳待开始 |
| 3.2 | 后端AI服务 - 个股分析 | 1天 | D9下午 | D10下午 | ⏳待开始 |
| 3.3 | 后端AI服务 - 连板梯队健康度 | 0.5天 | D10下午 | D11上午 | ⏳待开始 |
| 3.4 | 前端情绪分析页面 | 1天 | D11上午 | D11下午 | ⏳待开始 |
| **Phase 4** | **趋势分析页面** | **3天** | | | |
| 4.1 | 后端算法 - 主线识别 | 1天 | D12上午 | D12下午 | ⏳待开始 |
| 4.2 | 后端API - 趋势股票池 | 0.5天 | D12下午 | D13上午 | ⏳待开始 |
| 4.3 | 后端AI服务 - 趋势预判 | 0.5天 | D13上午 | D13下午 | ⏳待开始 |
| 4.4 | 前端趋势分析页面 | 1天 | D13下午 | D14上午 | ⏳待开始 |
| **Phase 5** | **测试与优化** | **1天** | | | |
| 5.1 | 集成测试 | 0.5天 | D14上午 | D14下午 | ⏳待开始 |
| 5.2 | 性能优化 | 0.5天 | D14下午 | D14下午 | ⏳待开始 |
| 5.3 | 文档与部署 | 0.5天 | D14下午 | D14下午 | ⏳待开始 |

**总计**: 14个工作日（2周）

---

## 四、里程碑

| 里程碑 | 日期 | 交付物 | 验收标准 |
|-------|------|--------|---------|
| M1: 基础设施完成 | D2 | • 豆包API配置完成<br>• 数据库Schema更新<br>• 30日历史数据采集完成 | • 豆包API测试调用成功<br>• market_stats表新增4字段<br>• market_index表有≥20日数据 |
| M2: 大盘分析页上线 | D8 | • 大盘分析页面完整<br>• 4个模块全部功能<br>• AI分析正常生成 | • K线图正常显示<br>• AI分析格式正确<br>• 概念卡片可点击 |
| M3: 情绪+趋势分析页上线 | D14 | • 情绪分析页面完整<br>• 趋势分析页面完整<br>• 3个页面互相导航 | • 连板股AI分析正常<br>• 主线识别准确<br>• 端到端测试通过 |
| M4: v2.0正式发布 | D14 | • 生产环境部署<br>• 文档更新完成<br>• Git tag v2.0 | • 生产环境无阻塞bug<br>• 性能达标 |

---

## 五、风险管理

### 5.1 技术风险

| 风险 | 概率 | 影响 | 缓解措施 | 应急方案 |
|------|------|------|---------|---------|
| 豆包API不稳定 | 中 | 高 | • 增加重试机制<br>• 设置超时<br>• 限流防滥用 | • 降级为规则引擎<br>• 显示"分析生成中" |
| AI输出质量不达标 | 中 | 中 | • Prompt工程优化<br>• 增加示例<br>• 人工review前100次 | • 调整Prompt模板<br>• 补充规则约束 |
| K线数据缺失 | 低 | 中 | • 多采集10天备用<br>• 数据校验 | • 显示占位图<br>• 提示"数据采集中" |
| 性能不达标 | 中 | 中 | • 添加Redis缓存<br>• 数据库索引优化 | • 限制并发用户<br>• 降低数据量 |

### 5.2 进度风险

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|---------|
| Prompt调优耗时超预期 | 高 | 中 | • 预留0.5天buffer<br>• 先用简单Prompt上线 |
| 前端组件开发延期 | 中 | 中 | • K线图用第三方库减少开发量<br>• 并行开发多个页面 |
| 豆包API限流 | 低 | 低 | • 提前申请更高配额<br>• 实施前端限流 |

---

## 六、质量保证

### 6.1 测试策略

| 测试类型 | 覆盖率目标 | 责任人 |
|---------|-----------|--------|
| 单元测试 | 核心业务逻辑 80% | 开发者 |
| 集成测试 | 3个页面端到端流程 | 开发者 |
| 性能测试 | 100并发压力测试 | 开发者 |
| 兼容性测试 | Chrome/Safari/Edge | 开发者 |

### 6.2 代码审查

- **后端代码**: AI服务Prompt设计需review
- **前端组件**: K线图性能需验证

---

## 七、交付清单

### 7.1 代码交付

- [ ] 后端新增8个API端点
- [ ] 前端新增3个页面
- [ ] 前端新增5个组件（K线图、概念卡片、股票卡片等）
- [ ] 单元测试代码

### 7.2 文档交付

- [ ] 二期需求文档（已完成）
- [ ] 二期技术方案（已完成）
- [ ] 二期开发计划（本文档）
- [ ] API文档更新
- [ ] README更新

### 7.3 部署交付

- [ ] 生产环境部署完成
- [ ] 豆包API配置完成
- [ ] Redis缓存（可选）配置完成
- [ ] Git tag v2.0

---

## 八、后续规划（v2.1+）

**优化方向**（v2.1，预计1周）:
1. K线图交互优化（缩放、拖拽）
2. AI分析质量提升（Prompt迭代）
3. 个股分析页面（初版）
4. 移动端响应式优化

**新功能**（v3.0，待规划）:
1. 实时行情推送（WebSocket）
2. 自选股管理
3. 回测系统
4. 社区功能

---

## 九、开发规范

### 9.1 代码规范

**后端**:
- 遵循PEP 8
- 函数添加类型提示
- 复杂逻辑添加注释
- 新增API必须写docstring

**前端**:
- 遵循Prettier格式化
- 组件添加TypeScript类型
- 复杂组件拆分
- Props添加注释

### 9.2 Git提交规范

```
<type>(<scope>): <subject>

feat(ai): 新增豆包API集成
fix(kline): 修复K线图均线计算错误
docs(api): 更新API文档
test(market): 添加市场分析单元测试
```

**Type类型**:
- `feat`: 新功能
- `fix`: Bug修复
- `docs`: 文档更新
- `style`: 代码格式调整
- `refactor`: 重构
- `test`: 测试相关
- `chore`: 构建/工具相关

---

## 十、联系与支持

**开发团队**: 开发者
**产品负责人**: 用户
**技术支持**: Claude Code

**沟通渠道**:
- 日常沟通：实时对话
- 需求变更：更新需求文档
- Bug跟踪：GitHub Issues

---

**文档状态**: ✅ 已完成
**下一步**: 等待用户确认，提供豆包API Key后启动开发
