#!/usr/bin/env python3
"""
æµ‹è¯•é¾™å¤´è‚¡æå–é€»è¾‘
éªŒè¯ï¼šè¿æ¿æ•°ä¼˜å…ˆ â†’ å°æ¿æ—¶é—´å…¶æ¬¡
"""

import sys, os
backend_dir = os.path.join(os.path.dirname(__file__), "..", "backend")
sys.path.insert(0, backend_dir)

from dotenv import load_dotenv
load_dotenv()

from app.services.collectors.hot_concepts_collector import HotConceptsCollector
from loguru import logger
import pandas as pd

logger.remove()
logger.add(sys.stdout, format="<green>{time:HH:mm:ss}</green> | <level>{level}</level> | {message}")

print("=" * 60)
print("ğŸ§ª é¾™å¤´è‚¡æå–é€»è¾‘æµ‹è¯•")
print("=" * 60)

# æ¨¡æ‹Ÿæ¶¨åœè‚¡æ± æ•°æ®
mock_data = pd.DataFrame([
    # è¿æ¿æ•°, å°æ¿æ—¶é—´, ä»£ç , åç§°, æ‰€å±è¡Œä¸š
    {"è¿æ¿æ•°": 3, "é¦–æ¬¡å°æ¿æ—¶é—´": "09:30:00", "ä»£ç ": "000001", "åç§°": "å¹³å®‰é“¶è¡Œ", "æ‰€å±è¡Œä¸š": "é“¶è¡Œ,é‡‘èç§‘æŠ€", "æ¶¨è·Œå¹…": 10.01},
    {"è¿æ¿æ•°": 3, "é¦–æ¬¡å°æ¿æ—¶é—´": "09:25:00", "ä»£ç ": "000002", "åç§°": "ä¸‡ç§‘A", "æ‰€å±è¡Œä¸š": "æˆ¿åœ°äº§,é“¶è¡Œ", "æ¶¨è·Œå¹…": 10.00},  # åº”è¯¥æ’ç¬¬ä¸€ï¼ˆåŒ3è¿æ¿ï¼Œä½†å°æ¿æ›´æ—©ï¼‰
    {"è¿æ¿æ•°": 2, "é¦–æ¬¡å°æ¿æ—¶é—´": "09:20:00", "ä»£ç ": "000003", "åç§°": "æ·±æŒ¯ä¸šA", "æ‰€å±è¡Œä¸š": "é“¶è¡Œ", "æ¶¨è·Œå¹…": 10.02},
    {"è¿æ¿æ•°": 4, "é¦–æ¬¡å°æ¿æ—¶é—´": "10:00:00", "ä»£ç ": "000004", "åç§°": "å›½åç½‘å®‰", "æ‰€å±è¡Œä¸š": "é“¶è¡Œ,ç½‘ç»œå®‰å…¨", "æ¶¨è·Œå¹…": 10.03},  # åº”è¯¥æ’ç¬¬ä¸€ï¼ˆ4è¿æ¿æœ€é«˜ï¼‰
    {"è¿æ¿æ•°": 1, "é¦–æ¬¡å°æ¿æ—¶é—´": "09:31:00", "ä»£ç ": "000005", "åç§°": "æ·±ç§‘æŠ€A", "æ‰€å±è¡Œä¸š": "ç§‘æŠ€,é“¶è¡Œ", "æ¶¨è·Œå¹…": 10.00},
])

print(f"\nğŸ“‹ æ¨¡æ‹Ÿæ¶¨åœè‚¡æ± æ•°æ®ï¼ˆå…± {len(mock_data)} åªï¼‰:")
print(mock_data[['ä»£ç ', 'åç§°', 'è¿æ¿æ•°', 'é¦–æ¬¡å°æ¿æ—¶é—´']])

collector = HotConceptsCollector()

# æµ‹è¯•æå–"é“¶è¡Œ"æ¦‚å¿µçš„é¾™å¤´è‚¡
print(f"\nğŸ” æå–ã€Œé“¶è¡Œã€æ¦‚å¿µçš„é¾™å¤´è‚¡ï¼ˆå‰3åªï¼‰...")
leading_stocks = collector.extract_leading_stocks_from_limit_up(
    concept_name="é“¶è¡Œ",
    limit_up_df=mock_data,
    limit=3
)

print(f"\nâœ… é¾™å¤´è‚¡æå–ç»“æœï¼ˆå…± {len(leading_stocks)} åªï¼‰:")
print("=" * 60)
for i, stock in enumerate(leading_stocks, 1):
    print(f"{i}. {stock['name']}({stock['code']}) - "
          f"{stock['continuous_days']}è¿æ¿ - "
          f"å°æ¿æ—¶é—´: {stock['first_limit_time']}")

print("\n" + "=" * 60)
print("âœ… é¢„æœŸæ’åº:")
print("  1. å›½åç½‘å®‰(000004) - 4è¿æ¿ - å°æ¿æ—¶é—´: 10:00:00  â† è¿æ¿æœ€å¤š")
print("  2. ä¸‡ç§‘A(000002) - 3è¿æ¿ - å°æ¿æ—¶é—´: 09:25:00  â† 3è¿æ¿ä¸­å°æ¿æœ€æ—©")
print("  3. å¹³å®‰é“¶è¡Œ(000001) - 3è¿æ¿ - å°æ¿æ—¶é—´: 09:30:00  â† 3è¿æ¿ä¸­å°æ¿ç¬¬äºŒæ—©")
print("=" * 60)

# éªŒè¯ç»“æœ
if len(leading_stocks) >= 3:
    assert leading_stocks[0]['code'] == '000004', "ç¬¬1ååº”è¯¥æ˜¯ 000004ï¼ˆ4è¿æ¿ï¼‰"
    assert leading_stocks[1]['code'] == '000002', "ç¬¬2ååº”è¯¥æ˜¯ 000002ï¼ˆ3è¿æ¿ï¼Œå°æ¿æœ€æ—©ï¼‰"
    assert leading_stocks[2]['code'] == '000001', "ç¬¬3ååº”è¯¥æ˜¯ 000001ï¼ˆ3è¿æ¿ï¼Œå°æ¿ç¬¬äºŒæ—©ï¼‰"
    print("\nâœ… é¾™å¤´è‚¡æ’åºé€»è¾‘éªŒè¯é€šè¿‡ï¼")
else:
    print("\nâŒ é¾™å¤´è‚¡æ•°é‡ä¸è¶³3åª")

print("=" * 60)
